<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - Mighty School For Valours</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a4b8c;
            --secondary: #f37b21;
            --accent: #34a853;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--primary);
            color: white;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover,
        .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--secondary);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .content-area {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }

        /* Section Styles */
        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 15px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #e06e1d;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(243, 123, 33, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-upcoming {
            background: #cce7ff;
            color: #004085;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Question Options */
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-label {
            width: 30px;
            font-weight: bold;
            color: var(--primary);
        }

        .correct-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--secondary);
        }

        .file-upload i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        .file-upload.active {
            border-color: var(--success);
            background: #f8fff9;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-error {
            color: var(--danger);
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        .stat-card:nth-child(2) {
            border-left-color: var(--secondary);
        }

        .stat-card:nth-child(3) {
            border-left-color: var(--success);
        }

        .stat-card:nth-child(4) {
            border-left-color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .action-buttons {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Add to your existing CSS */
        #togglePassword {
            background: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
        }

        #togglePassword:hover {
            background: none !important;
            color: var(--primary) !important;
        }

        #togglePassword:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Debug styles - remove after fixing */
        .debug-border {
            border: 2px solid red !important;
        }
    </style>
</head>

<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-container">
            <div class="login-header">
                <h2>Staff Login</h2>
                <p>Enter your Staff ID and password</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginStaffId">Staff ID</label>
                    <input type="text" id="loginStaffId" class="form-control" placeholder="Enter your Staff ID"
                        required>
                </div>
                <!-- Replace the existing password field in login form -->
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter password"
                            required>
                        <button type="button" id="togglePassword"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <div id="loginError" class="login-error">
                    Invalid Staff ID or password
                </div>
            </form>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>MSV Staff</span>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </li>
                <li class="menu-item" data-section="students">
                    <i class="fas fa-users"></i>
                    <span>Student Management</span>
                </li>
                <li class="menu-item" data-section="questions">
                    <i class="fas fa-question-circle"></i>
                    <span>Questions Bank</span>
                </li>
                <li class="menu-item" data-section="exams">
                    <i class="fas fa-file-alt"></i>
                    <span>My Exams</span>
                </li>
                <li class="menu-item" data-section="results">
                    <i class="fas fa-chart-bar"></i>
                    <span>Results & Analytics</span>
                </li>
                <li class="menu-item" data-section="profile">
                    <i class="fas fa-user"></i>
                    <span>My Profile</span>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <h3>Staff Dashboard</h3>
                <div class="user-info">
                    <span id="staffName">Staff Member</span>
                    <button class="btn btn-outline" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-tachometer-alt"></i> My Dashboard
                        </h2>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 style="font-size: 2.5rem; color: var(--primary); margin-bottom: 10px;"
                                id="totalQuestions">0</h3>
                            <p style="color: #666;">My Questions</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="font-size: 2.5rem; color: var(--secondary); margin-bottom: 10px;"
                                id="totalExams">0</h3>
                            <p style="color: #666;">My Exams</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="font-size: 2.5rem; color: var(--success); margin-bottom: 10px;" id="activeExams">
                                0</h3>
                            <p style="color: #666;">Active Exams</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="font-size: 2.5rem; color: var(--accent); margin-bottom: 10px;"
                                id="totalStudents">0</h3>
                            <p style="color: #666;">My Students</p>
                        </div>
                    </div>

                    <div class="recent-activity"
                        style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">Recent Activity</h3>
                        <div id="recentActivity">
                            <p style="text-align: center; color: #666; padding: 20px;">Loading recent activity...</p>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">My Assigned Subjects & Classes</h3>
                        <div id="assignedInfo" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <p style="color: #666;">Loading assigned information...</p>
                        </div>
                    </div>
                </div>
                <!-- Student Management Section -->
                <div id="students" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-users"></i> Student Management
                        </h2>
                        <button class="btn btn-primary" id="addStudentBtn">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentFilterClass">Filter by Class</label>
                                <select id="studentFilterClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="studentFilterSubject">Filter by Subject</label>
                                <select id="studentFilterSubject" class="form-control">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Admission No</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px;">Loading students data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Questions Bank Section -->
                <div id="questions" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-question-circle"></i> Questions Bank
                        </h2>
                        <div>
                            <button class="btn btn-danger" id="deleteSelectedBtn" style="margin-right: 10px;">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-primary" id="addQuestionBtn">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                            <button class="btn btn-success" id="bulkUploadBtn" style="margin-left: 10px;">
                                <i class="fas fa-upload"></i> Bulk Upload
                            </button>
                        </div>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filterSubject">Filter by Subject</label>
                                <select id="filterSubject" class="form-control">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterClass">Filter by Class</label>
                                <select id="filterClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterDifficulty">Filter by Difficulty</label>
                                <select id="filterDifficulty" class="form-control">
                                    <option value="">All Difficulties</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllQuestions" style="margin: 0;">
                                    </th>
                                    <th>Question</th>
                                    <th>Subject</th>
                                    <th>Class</th>
                                    <th>Difficulty</th>
                                    <th>Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="questionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px;">Loading questions data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Exams Section -->
                <div id="exams" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-file-alt"></i> My Exams
                        </h2>
                        <button class="btn btn-primary" id="createExamBtn">
                            <i class="fas fa-plus"></i> Create Exam
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Exam Title</th>
                                    <th>Subject</th>
                                    <th>Class</th>
                                    <th>Duration</th>
                                    <th>Questions</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="examsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">Loading exams data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Results & Analytics Section -->
                <div id="results" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-chart-bar"></i> Results & Analytics
                        </h2>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="resultsExam">Select Exam</label>
                                <select id="resultsExam" class="form-control">
                                    <option value="">Select Exam</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="resultsClass">Select Class</label>
                                <select id="resultsClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" style="margin-top: 25px;" id="generateReportBtn">
                                    <i class="fas fa-chart-bar"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="resultsContent">
                        <div class="chart-container">
                            <h3 class="chart-title">Performance Overview</h3>
                            <div id="performanceChart"
                                style="height: 300px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #666;">
                                Select an exam to view performance chart
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Admission No</th>
                                        <th>Score</th>
                                        <th>Percentage</th>
                                        <th>Grade</th>
                                        <th>Time Spent</th>
                                        <th>Submitted</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 20px;">Select an exam to
                                            view results</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-user"></i> My Profile
                        </h2>
                    </div>

                    <div class="form-row">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">Personal Information</h3>
                            <form id="profileForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileFirstName">First Name</label>
                                        <input type="text" id="profileFirstName" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="profileLastName">Last Name</label>
                                        <input type="text" id="profileLastName" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail">Email</label>
                                    <input type="email" id="profileEmail" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Profile</button>
                            </form>
                        </div>

                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">Change Password</h3>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm New Password</label>
                                    <input type="password" id="confirmPassword" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Change Password</button>
                            </form>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">Assigned Subjects & Classes</h3>
                        <div id="profileAssignedInfo" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <p style="color: #666;">Loading assigned information...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Question</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="form-group">
                        <label for="questionText">Question Text</label>
                        <textarea id="questionText" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="questionSubject">Subject</label>
                            <select id="questionSubject" class="form-control" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionClass">Class</label>
                            <select id="questionClass" class="form-control" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="questionMarks">Marks</label>
                            <input type="number" id="questionMarks" class="form-control" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="questionDifficulty">Difficulty</label>
                            <select id="questionDifficulty" class="form-control" required>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Options</label>
                        <div class="option-row">
                            <span class="option-label">A:</span>
                            <input type="text" id="optionA" class="form-control" required>
                        </div>
                        <div class="option-row">
                            <span class="option-label">B:</span>
                            <input type="text" id="optionB" class="form-control" required>
                        </div>
                        <div class="option-row">
                            <span class="option-label">C:</span>
                            <input type="text" id="optionC" class="form-control" required>
                        </div>
                        <div class="option-row">
                            <span class="option-label">D:</span>
                            <input type="text" id="optionD" class="form-control" required>
                        </div>
                        <div class="correct-option">
                            <label for="correctOption">Correct Answer:</label>
                            <select id="correctOption" class="form-control" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelQuestionBtn">Cancel</button>
                <button class="btn btn-primary" id="saveQuestionBtn">Save Question</button>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Upload Questions</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="file-upload" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Upload Excel File</h4>
                    <p>Drag & drop your Excel file here or click to browse</p>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;">
                    <button class="btn btn-outline" onclick="document.getElementById('excelFile').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                </div>
                <div id="filePreview" style="display: none; margin-top: 20px;">
                    <h4>File Preview</h4>
                    <div class="table-container">
                        <table class="data-table" id="previewTable">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Option A</th>
                                    <th>Option B</th>
                                    <th>Option C</th>
                                    <th>Option D</th>
                                    <th>Correct</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="uploadSubject">Subject</label>
                        <select id="uploadSubject" class="form-control" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="uploadClass">Class</label>
                        <select id="uploadClass" class="form-control" required>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelUploadBtn">Cancel</button>
                <button class="btn btn-primary" id="processUploadBtn" disabled>Process Upload</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="studentModalTitle">Add Student</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentAdmissionNo">Admission Number *</label>
                            <input type="text" id="studentAdmissionNo" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="studentClass">Class *</label>
                            <select id="studentClass" class="form-control" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentFirstName">First Name *</label>
                            <input type="text" id="studentFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="studentLastName">Last Name *</label>
                            <input type="text" id="studentLastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="studentPhone">Phone Number</label>
                        <input type="tel" id="studentPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="studentPassword">Password *</label>
                        <input type="password" id="studentPassword" class="form-control" required>
                        <small class="form-text text-muted">Default password for new students</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="studentActive" checked> Active Student
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelStudentBtn">Cancel</button>
                <button class="btn btn-primary" id="saveStudentBtn">Save Student</button>
            </div>
        </div>
    </div>

    <!-- Create Exam Modal -->
    <div id="createExamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Exam</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createExamForm">
                    <div class="form-group">
                        <label for="examTitle">Exam Title</label>
                        <input type="text" id="examTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="examDescription">Description</label>
                        <textarea id="examDescription" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="examSubject">Subject</label>
                            <select id="examSubject" class="form-control" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examClass">Class</label>
                            <select id="examClass" class="form-control" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="examDuration">Duration (minutes)</label>
                            <input type="number" id="examDuration" class="form-control" value="60" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="examTotalQuestions">Total Questions</label>
                            <input type="number" id="examTotalQuestions" class="form-control" value="20" min="1"
                                required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="examAvailableFrom">Available From</label>
                            <input type="datetime-local" id="examAvailableFrom" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="examAvailableUntil">Available Until</label>
                            <input type="datetime-local" id="examAvailableUntil" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shuffleQuestions" checked> Shuffle Questions
                        </label>
                        <label style="margin-left: 20px;">
                            <input type="checkbox" id="allowMultipleAttempts"> Allow Multiple Attempts
                        </label>
                    </div>
                    <div class="form-group" id="maxAttemptsContainer" style="display: none;">
                        <label for="maxAttempts">Maximum Attempts</label>
                        <input type="number" id="maxAttempts" class="form-control" value="1" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelExamBtn">Cancel</button>
                <button class="btn btn-primary" id="saveExamBtn">Create Exam</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDJln5uWh_xmDA7bXowbFT-yL6zlBPtRg",
            authDomain: "mightyschoolforvalours-91aa4.firebaseapp.com",
            projectId: "mightyschoolforvalours-91aa4",
            storageBucket: "mightyschoolforvalours-91aa4.firebasestorage.app",
            messagingSenderId: "778024125256",
            appId: "1:778024125256:web:31d482406bf06a2125a97d",
            measurementId: "G-C2NY58GRFT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentStaff = null;
        let subjects = [];
        let classes = [];
        let questions = [];
        let exams = [];
        let results = [];
        let uploadedQuestions = [];
        let currentSettings = null;
        let staffSubjects = [];
        let staffClasses = [];
        let selectedQuestionIds = new Set();
        let currentEditingStudentId = null;

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const staffName = document.getElementById('staffName');
        const logoutBtn = document.getElementById('logoutBtn');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initApp);
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        // Initialize application
        function initApp() {
            console.log('Initializing application...');

            // Check if user is already logged in
            const savedUser = localStorage.getItem('staffUser');
            if (savedUser) {
                try {
                    currentStaff = JSON.parse(savedUser);
                    console.log('Found saved user:', currentStaff);
                    showStaffInterface();

                    // Wait a bit for DOM to be fully ready
                    setTimeout(() => {
                        setupEventListeners();
                        setupModalControls();
                        setupPasswordToggle();
                        loadInitialData();
                    }, 100);

                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    loginModal.style.display = 'flex';
                }
            } else {
                console.log('No saved user found, showing login');
                loginModal.style.display = 'flex';

                // Setup login-related listeners
                setTimeout(() => {
                    setupPasswordToggle();
                }, 100);
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');

            // Menu navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.getAttribute('data-section');

                    // Update active menu item
                    document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
                    item.classList.add('active');

                    // Show corresponding section
                    document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');

                    // Load section data
                    loadSectionData(sectionId);
                });
            });

            // Student Management
            document.getElementById('addStudentBtn')?.addEventListener('click', () => {
                loadSubjectsAndClasses().then(() => {
                    openStudentModal();
                });
            });

            document.getElementById('saveStudentBtn')?.addEventListener('click', saveStudent);
            document.getElementById('cancelStudentBtn')?.addEventListener('click', () => {
                hideModal('addStudentModal');
                resetStudentForm();
            });
            // Questions Management
            document.getElementById('addQuestionBtn')?.addEventListener('click', () => {
                loadSubjectsAndClasses().then(() => {
                    populateQuestionForm();
                    showModal('addQuestionModal');
                });
            });

            document.getElementById('bulkUploadBtn')?.addEventListener('click', () => {
                loadSubjectsAndClasses().then(() => {
                    populateUploadForm();
                    showModal('bulkUploadModal');
                });
            });

            document.getElementById('deleteSelectedBtn')?.addEventListener('click', deleteSelectedQuestions);
            document.getElementById('saveQuestionBtn')?.addEventListener('click', saveQuestion);
            document.getElementById('processUploadBtn')?.addEventListener('click', processBulkUpload);

            // Exams Management
            document.getElementById('createExamBtn')?.addEventListener('click', () => {
                loadSubjectsAndClasses().then(() => {
                    populateExamForm();
                    showModal('createExamModal');
                });
            });

            document.getElementById('saveExamBtn')?.addEventListener('click', saveExam);

            // Results & Analytics
            document.getElementById('generateReportBtn')?.addEventListener('click', generateReport);

            // Profile Management
            document.getElementById('profileForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                updateProfile(e);
            });

            document.getElementById('passwordForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                changePassword(e);
            });

            // Student Filters
            document.getElementById('studentFilterClass')?.addEventListener('change', filterStudents);
            document.getElementById('studentFilterSubject')?.addEventListener('change', filterStudents);

            // Question Filters
            const filters = ['filterSubject', 'filterClass', 'filterDifficulty'];
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', filterQuestions);
                }
            });

            // Multiple attempts toggle
            const allowMultipleAttempts = document.getElementById('allowMultipleAttempts');
            if (allowMultipleAttempts) {
                allowMultipleAttempts.addEventListener('change', function () {
                    const container = document.getElementById('maxAttemptsContainer');
                    if (container) {
                        container.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }

            // File upload handling
            const excelFile = document.getElementById('excelFile');
            const fileUploadArea = document.getElementById('fileUploadArea');

            if (excelFile) excelFile.addEventListener('change', handleFileUpload);
            if (fileUploadArea) {
                fileUploadArea.addEventListener('dragover', handleDragOver);
                fileUploadArea.addEventListener('drop', handleFileDrop);
            }

            console.log('Event listeners setup completed');
        }

        // Setup password toggle
        function setupPasswordToggle() {
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('loginPassword');

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.type === 'password' ? 'text' : 'password';
                    passwordInput.type = type;

                    // Toggle eye icon
                    const icon = this.querySelector('i');
                    if (type === 'text') {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            }
        }

        // Setup modal controls
        function setupModalControls() {
            // Close buttons
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', (e) => {
                    const modal = closeBtn.closest('.modal');
                    if (modal.id === 'addStudentModal') {
                        resetStudentForm();
                    }
                    modal.classList.remove('active');
                });
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        if (modal.id === 'addStudentModal') {
                            resetStudentForm();
                        }
                        modal.classList.remove('active');
                    }
                });
            });


            // Cancel buttons
            document.getElementById('cancelQuestionBtn')?.addEventListener('click', () => hideModal('addQuestionModal'));
            document.getElementById('cancelUploadBtn')?.addEventListener('click', () => hideModal('bulkUploadModal'));
            document.getElementById('cancelExamBtn')?.addEventListener('click', () => hideModal('createExamModal'));
            document.getElementById('cancelStudentBtn')?.addEventListener('click', () => hideModal('addStudentModal'));

            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();

            const staffId = document.getElementById('loginStaffId').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Check if user exists in Firestore using staffId
                const usersSnapshot = await db.collection('users')
                    .where('staffId', '==', staffId)
                    .where('password', '==', password)
                    .where('role', '==', 'staff')
                    .get();

                if (!usersSnapshot.empty) {
                    const userDoc = usersSnapshot.docs[0];
                    currentStaff = userDoc.data();
                    currentStaff.userId = userDoc.id;

                    localStorage.setItem('staffUser', JSON.stringify(currentStaff));
                    showStaffInterface();
                    loginModal.style.display = 'none';
                    loginError.style.display = 'none';
                    loadInitialData();
                } else {
                    loginError.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.style.display = 'block';
            }
        }

        function handleLogout() {
            currentStaff = null;
            localStorage.removeItem('staffUser');
            loginModal.style.display = 'flex';
            document.getElementById('loginForm').reset();

            // Reset password visibility
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = document.getElementById('togglePassword')?.querySelector('i');
            if (passwordInput && toggleIcon) {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        function showStaffInterface() {
            staffName.textContent = `${currentStaff.firstName} ${currentStaff.lastName}`;
        }

        // Data Loading Functions
        async function loadInitialData() {
            try {
                // Set staff assigned subjects and classes first
                staffSubjects = currentStaff.subjects || [];
                staffClasses = currentStaff.assignedClasses || [];

                await loadSubjectsAndClasses();
                await loadSettings();
                await loadDashboardData();
            } catch (error) {
                console.error('Error in loadInitialData:', error);
                showNotification('Error loading initial data', 'error');
            }
        }

        async function loadSubjectsAndClasses() {
            try {
                const [subjectsSnapshot, classesSnapshot] = await Promise.all([
                    db.collection('subjects').get(),
                    db.collection('classes').get()
                ]);

                let allSubjects = subjectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                let allClasses = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Filter subjects and classes based on staff assignments
                if (staffSubjects && staffSubjects.length > 0) {
                    subjects = allSubjects.filter(subject => staffSubjects.includes(subject.id));
                } else {
                    subjects = [];
                }

                if (staffClasses && staffClasses.length > 0) {
                    classes = allClasses.filter(cls => staffClasses.includes(cls.id));
                } else {
                    classes = [];
                }

                // Update filter dropdowns
                updateFilterDropdowns();
            } catch (error) {
                console.error('Error loading subjects and classes:', error);
                subjects = [];
                classes = [];
            }
        }

        async function loadSettings() {
            try {
                const settingsSnapshot = await db.collection('settings').doc('school_settings').get();
                if (settingsSnapshot.exists) {
                    currentSettings = settingsSnapshot.data();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function loadSectionData(sectionId) {
            switch (sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'questions':
                    loadQuestionsData();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'results':
                    loadResultsData();
                    break;
                case 'profile':
                    loadProfileData();
                    break;
                case 'students':
                    loadStudentsData();
                    break;
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');

                // Get questions and exams
                const [questionsSnapshot, examsSnapshot] = await Promise.all([
                    db.collection('questions')
                        .where('createdBy', '==', currentStaff.userId)
                        .get(),
                    db.collection('exams')
                        .where('createdBy', '==', currentStaff.userId)
                        .get()
                ]);

                console.log(`Found ${questionsSnapshot.size} questions, ${examsSnapshot.size} exams`);

                // Get student count
                let studentsCount = 0;
                if (staffClasses && staffClasses.length > 0) {
                    console.log('Fetching students for classes:', staffClasses);

                    for (const classId of staffClasses) {
                        try {
                            const studentsSnapshot = await db.collection('users')
                                .where('role', '==', 'student')
                                .where('class', '==', classId)
                                .get();
                            studentsCount += studentsSnapshot.size;
                            console.log(`Class ${classId}: ${studentsSnapshot.size} students`);
                        } catch (error) {
                            console.error(`Error fetching students for class ${classId}:`, error);
                        }
                    }
                }

                // Calculate active exams
                const now = new Date();
                let activeExams = 0;
                let recentResults = [];

                examsSnapshot.forEach(doc => {
                    const exam = doc.data();
                    let availableUntil = null;

                    // Safely convert timestamp
                    if (exam.availableUntil) {
                        if (exam.availableUntil.toDate) {
                            availableUntil = exam.availableUntil.toDate();
                        } else if (exam.availableUntil.seconds) {
                            availableUntil = new Date(exam.availableUntil.seconds * 1000);
                        }
                    }

                    if (availableUntil && now <= availableUntil) {
                        activeExams++;
                    }
                });

                // Get recent results
                if (examsSnapshot.size > 0) {
                    const examIds = examsSnapshot.docs.map(doc => doc.id);
                    console.log('Fetching results for exams:', examIds);

                    // Get results for first 5 exams
                    for (let i = 0; i < Math.min(examIds.length, 5); i++) {
                        try {
                            const resultsSnapshot = await db.collection('results')
                                .where('examId', '==', examIds[i])
                                .orderBy('submittedAt', 'desc')
                                .limit(3)
                                .get();

                            resultsSnapshot.forEach(doc => {
                                recentResults.push({ id: doc.id, ...doc.data() });
                            });
                        } catch (error) {
                            console.error(`Error fetching results for exam ${examIds[i]}:`, error);
                        }
                    }

                    // Sort by date and take top 5
                    recentResults.sort((a, b) => {
                        const dateA = getTimestamp(a.submittedAt);
                        const dateB = getTimestamp(b.submittedAt);
                        return dateB - dateA;
                    }).splice(5);
                }

                console.log(`Dashboard stats - Questions: ${questionsSnapshot.size}, Exams: ${examsSnapshot.size}, Active: ${activeExams}, Students: ${studentsCount}, Recent Results: ${recentResults.length}`);

                // Update UI
                document.getElementById('totalQuestions').textContent = questionsSnapshot.size;
                document.getElementById('totalExams').textContent = examsSnapshot.size;
                document.getElementById('activeExams').textContent = activeExams;
                document.getElementById('totalStudents').textContent = studentsCount;

                // Load recent activity and assigned info
                loadRecentActivity(recentResults);
                loadAssignedInformation();

                showNotification('Dashboard loaded successfully!', 'success');

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error loading dashboard data', 'error');

                // Set default values
                document.getElementById('totalQuestions').textContent = '0';
                document.getElementById('totalExams').textContent = '0';
                document.getElementById('activeExams').textContent = '0';
                document.getElementById('totalStudents').textContent = '0';
            }
        }

        // Helper function for timestamp conversion
        function getTimestamp(timestamp) {
            if (!timestamp) return new Date(0);
            if (timestamp.toDate) return timestamp.toDate();
            if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
            if (timestamp instanceof Date) return timestamp;
            return new Date(0);
        }

        function loadRecentActivity(results) {
            const activityContainer = document.getElementById('recentActivity');

            if (!activityContainer) {
                console.error('Recent activity container not found!');
                return;
            }

            if (!results || results.length === 0) {
                activityContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No recent exam activity</p>';
                return;
            }

            let activityHTML = '';
            results.forEach(result => {
                const submittedDate = getTimestamp(result.submittedAt).toLocaleString();
                const examTitle = result.examTitle || 'Unknown Exam';
                const percentage = result.percentage || 0;

                activityHTML += `
            <div style="padding: 10px; border-left: 4px solid var(--secondary); background: #f8f9fa; margin-bottom: 10px;">
                <strong>Exam Completed</strong>
                <p style="margin: 5px 0 0 0; color: #666;">
                    Student scored ${percentage}% in ${examTitle}
                </p>
                <small style="color: #999;">${submittedDate}</small>
            </div>
        `;
            });

            activityContainer.innerHTML = activityHTML;
            console.log(`Loaded ${results.length} recent activities`);
        }

        function loadAssignedInformation() {
            const assignedInfo = document.getElementById('assignedInfo');
            const profileAssignedInfo = document.getElementById('profileAssignedInfo');

            if (!assignedInfo && !profileAssignedInfo) {
                console.error('Assigned info containers not found!');
                return;
            }

            let assignedHTML = '';

            // Load subjects and classes first if not loaded
            if (subjects.length === 0 || classes.length === 0) {
                assignedHTML = '<p style="color: #666;">Loading assigned information...</p>';
            } else {
                if (staffSubjects.length > 0) {
                    assignedHTML += '<h4 style="margin-bottom: 10px; color: var(--primary);">Assigned Subjects:</h4>';
                    assignedHTML += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">';

                    staffSubjects.forEach(subjectId => {
                        const subject = subjects.find(s => s.id === subjectId);
                        if (subject) {
                            assignedHTML += `<span style="background: var(--primary); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">${subject.subjectName}</span>`;
                        } else {
                            assignedHTML += `<span style="background: #ccc; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">Unknown Subject (${subjectId})</span>`;
                        }
                    });
                    assignedHTML += '</div>';
                }

                if (staffClasses.length > 0) {
                    assignedHTML += '<h4 style="margin-bottom: 10px; color: var(--primary);">Assigned Classes:</h4>';
                    assignedHTML += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';

                    staffClasses.forEach(classId => {
                        const cls = classes.find(c => c.id === classId);
                        if (cls) {
                            assignedHTML += `<span style="background: var(--secondary); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">${cls.className}</span>`;
                        } else {
                            assignedHTML += `<span style="background: #ccc; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">Unknown Class (${classId})</span>`;
                        }
                    });
                    assignedHTML += '</div>';
                }

                if (!assignedHTML) {
                    assignedHTML = '<p style="color: #666;">No subjects or classes assigned yet.</p>';
                }
            }

            if (assignedInfo) assignedInfo.innerHTML = assignedHTML;
            if (profileAssignedInfo) profileAssignedInfo.innerHTML = assignedHTML;

            console.log('Assigned information loaded');
        }

        // Student Management Functions
        async function loadStudentsData() {
            try {
                if (!staffClasses || staffClasses.length === 0) {
                    document.getElementById('studentsTableBody').innerHTML =
                        '<tr><td colspan="6" style="text-align: center; padding: 20px;">No classes assigned</td></tr>';
                    updateStudentFilters();
                    return;
                }

                // Get students from all assigned classes
                const studentPromises = staffClasses.map(classId =>
                    db.collection('users')
                        .where('role', '==', 'student')
                        .where('class', '==', classId)
                        .get()
                );

                const studentSnapshots = await Promise.all(studentPromises);
                let students = studentSnapshots.flatMap(snapshot =>
                    snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                );

                // Also get students enrolled in staff's subjects
                if (staffSubjects && staffSubjects.length > 0) {
                    const subjectStudentsSnapshot = await db.collection('users')
                        .where('role', '==', 'student')
                        .where('subjects', 'array-contains-any', staffSubjects)
                        .get();

                    const subjectStudents = subjectStudentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Merge and remove duplicates
                    const allStudents = [...students, ...subjectStudents];
                    students = allStudents.filter((student, index, self) =>
                        index === self.findIndex(s => s.id === student.id)
                    );
                }

                // Store all students for filtering
                window.allStudents = students;

                populateStudentsTable(students);
                updateStudentFilters();
            } catch (error) {
                console.error('Error loading students data:', error);
                showNotification('Error loading students data', 'error');
            }
        }

        function updateStudentFilters() {
            const classFilter = document.getElementById('studentFilterClass');
            const subjectFilter = document.getElementById('studentFilterSubject');

            if (classFilter) {
                classFilter.innerHTML = '<option value="">All Classes</option>';
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.className;
                    classFilter.appendChild(option);
                });
            }

            if (subjectFilter) {
                subjectFilter.innerHTML = '<option value="">All Subjects</option>';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.subjectName;
                    subjectFilter.appendChild(option);
                });
            }
        }

        function filterStudents() {
            const classFilter = document.getElementById('studentFilterClass').value;
            const subjectFilter = document.getElementById('studentFilterSubject').value;

            let filteredStudents = window.allStudents || [];

            if (classFilter) {
                filteredStudents = filteredStudents.filter(student => student.class === classFilter);
            }

            if (subjectFilter) {
                filteredStudents = filteredStudents.filter(student =>
                    student.subjects && student.subjects.includes(subjectFilter)
                );
            }

            populateStudentsTable(filteredStudents);
        }

        function populateStudentsTable(students) {
            const studentsTableBody = document.getElementById('studentsTableBody');

            if (!students || students.length === 0) {
                studentsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No students found matching the criteria</td></tr>';
                return;
            }

            studentsTableBody.innerHTML = '';
            students.forEach(student => {
                const cls = classes.find(c => c.id === student.class);

                // Check if staff is class teacher for this student's class
                const isClassTeacher = staffClasses.includes(student.class);

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${student.admissionNumber}</td>
            <td>${student.firstName} ${student.lastName}</td>
            <td>${cls?.className || student.class}</td>
            <td>${student.phone || 'N/A'}</td>
            <td>
                <span class="status-badge ${student.isActive ? 'status-active' : 'status-inactive'}">
                    ${student.isActive ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="action-buttons">
                ${isClassTeacher ? `
                    <button class="action-btn btn-primary" onclick="editStudent('${student.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn btn-danger" onclick="deleteStudent('${student.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <span style="color: #666; font-size: 0.9rem;">View Only</span>
                `}
            </td>
        `;
                studentsTableBody.appendChild(row);
            });
        }

        function openStudentModal() {
            populateStudentForm();
            resetStudentForm(); // Ensure fresh state
            showModal('addStudentModal');
        }

        function populateStudentForm() {
            const classSelect = document.getElementById('studentClass');
            classSelect.innerHTML = '<option value="">Select Class</option>';

            // Only show classes where staff is class teacher
            classes.forEach(cls => {
                if (staffClasses.includes(cls.id)) {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.className;
                    classSelect.appendChild(option);
                }
            });

            // Set default password
            document.getElementById('studentPassword').value = 'password123';

            // Reset form
            document.getElementById('studentForm').reset();
            document.getElementById('studentActive').checked = true;
        }

        async function saveStudent() {
            const classId = document.getElementById('studentClass').value;
            const admissionNumber = document.getElementById('studentAdmissionNo').value;

            // Check if staff is class teacher for the selected class
            if (!staffClasses.includes(classId)) {
                showNotification('You are not authorized to add students to this class.', 'error');
                return;
            }

            const studentData = {
                admissionNumber: admissionNumber,
                firstName: document.getElementById('studentFirstName').value,
                lastName: document.getElementById('studentLastName').value,
                phone: document.getElementById('studentPhone').value,
                class: classId,
                role: 'student',
                isActive: document.getElementById('studentActive').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Only include password for new students, not when editing
            if (!currentEditingStudentId) {
                studentData.password = document.getElementById('studentPassword').value;
                studentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                // Check if admission number already exists (excluding current student if editing)
                const existingStudentQuery = await db.collection('users')
                    .where('admissionNumber', '==', studentData.admissionNumber)
                    .get();

                let admissionNumberExists = false;

                if (currentEditingStudentId) {
                    // For editing: check if any other student has this admission number
                    admissionNumberExists = existingStudentQuery.docs.some(doc =>
                        doc.id !== currentEditingStudentId
                    );
                } else {
                    // For new student: check if any student has this admission number
                    admissionNumberExists = !existingStudentQuery.empty;
                }

                if (admissionNumberExists) {
                    showNotification('Admission number already exists!', 'error');
                    return;
                }

                if (currentEditingStudentId) {
                    // Update existing student
                    await db.collection('users').doc(currentEditingStudentId).update(studentData);
                    showNotification('Student updated successfully!', 'success');
                } else {
                    // Create new student
                    await db.collection('users').add(studentData);
                    showNotification('Student added successfully!', 'success');
                }

                hideModal('addStudentModal');
                resetStudentForm();
                loadStudentsData();
            } catch (error) {
                console.error('Error saving student:', error);
                showNotification('Error saving student. Please try again.', 'error');
            }
        }

        async function editStudent(studentId) {
            try {
                const studentDoc = await db.collection('users').doc(studentId).get();
                if (!studentDoc.exists) {
                    showNotification('Student not found!', 'error');
                    return;
                }

                const student = studentDoc.data();

                // Check if staff is class teacher for this student's class
                if (!staffClasses.includes(student.class)) {
                    showNotification('You are not authorized to edit this student.', 'error');
                    return;
                }

                currentEditingStudentId = studentId;
                document.getElementById('studentModalTitle').textContent = 'Edit Student';

                // Populate form with student data
                document.getElementById('studentAdmissionNo').value = student.admissionNumber;
                document.getElementById('studentFirstName').value = student.firstName;
                document.getElementById('studentLastName').value = student.lastName;
                document.getElementById('studentPhone').value = student.phone || '';
                document.getElementById('studentClass').value = student.class;
                document.getElementById('studentActive').checked = student.isActive !== false;

                // Hide password field for editing and clear any existing value
                const passwordGroup = document.getElementById('studentPassword').closest('.form-group');
                passwordGroup.style.display = 'none';
                document.getElementById('studentPassword').value = '';

                showModal('addStudentModal');
            } catch (error) {
                console.error('Error loading student data:', error);
                showNotification('Error loading student data', 'error');
            }
        }

        // Reset function for the student form:
        function resetStudentForm() {
            document.getElementById('studentForm').reset();
            currentEditingStudentId = null;
            document.getElementById('studentModalTitle').textContent = 'Add Student';

            // Show password field and set default password for new students
            const passwordGroup = document.getElementById('studentPassword').closest('.form-group');
            passwordGroup.style.display = 'block';
            document.getElementById('studentPassword').value = 'password123';
            document.getElementById('studentActive').checked = true;
        }

        async function deleteStudent(studentId) {
            try {
                const studentDoc = await db.collection('users').doc(studentId).get();
                if (!studentDoc.exists) {
                    showNotification('Student not found!', 'error');
                    return;
                }

                const student = studentDoc.data();

                // Check if staff is class teacher for this student's class
                if (!staffClasses.includes(student.class)) {
                    showNotification('You are not authorized to delete this student.', 'error');
                    return;
                }

                if (confirm('Are you sure you want to delete this student?')) {
                    await db.collection('users').doc(studentId).delete();
                    loadStudentsData();
                    showNotification('Student deleted successfully!', 'success');
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                showNotification('Error deleting student.', 'error');
            }
        }

        // Questions Bank Functions
        async function loadQuestionsData() {
            try {
                const questionsSnapshot = await db.collection('questions')
                    .where('createdBy', '==', currentStaff.userId)
                    .get();

                questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateQuestionsTable(questions);
            } catch (error) {
                console.error('Error loading questions data:', error);
            }
        }

        function populateQuestionsTable(questions) {
            const questionsTableBody = document.getElementById('questionsTableBody');

            if (questions.length === 0) {
                questionsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No questions found</td></tr>';
                return;
            }

            questionsTableBody.innerHTML = '';
            questions.forEach(question => {
                const subject = subjects.find(s => s.id === question.subjectId);
                const cls = classes.find(c => c.id === question.classId);

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <input type="checkbox" class="question-checkbox" value="${question.id}" style="margin: 0;">
            </td>
            <td>${question.questionText.substring(0, 100)}${question.questionText.length > 100 ? '...' : ''}</td>
            <td>${subject?.subjectName || question.subjectId}</td>
            <td>${cls?.className || question.classId}</td>
            <td>
                <span class="status-badge ${question.difficulty === 'easy' ? 'status-active' : question.difficulty === 'medium' ? 'status-warning' : 'status-inactive'}">
                    ${question.difficulty}
                </span>
            </td>
            <td>${question.marks}</td>
            <td class="action-buttons">
                <button class="action-btn btn-primary" onclick="editQuestion('${question.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn btn-danger" onclick="deleteQuestion('${question.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
                questionsTableBody.appendChild(row);
            });

            // Setup batch selection
            setupBatchSelection();
        }

        function setupBatchSelection() {
            const selectAll = document.getElementById('selectAllQuestions');
            const checkboxes = document.querySelectorAll('.question-checkbox');

            if (selectAll) {
                selectAll.addEventListener('change', function () {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        if (this.checked) {
                            selectedQuestionIds.add(checkbox.value);
                        } else {
                            selectedQuestionIds.delete(checkbox.value);
                        }
                    });
                });
            }

            // Update individual checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        selectedQuestionIds.add(this.value);
                    } else {
                        selectedQuestionIds.delete(this.value);
                        // Uncheck select all if any checkbox is unchecked
                        if (selectAll) selectAll.checked = false;
                    }
                });
            });
        }

        function populateQuestionForm() {
            const subjectSelect = document.getElementById('questionSubject');
            const classSelect = document.getElementById('questionClass');

            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            classSelect.innerHTML = '<option value="">Select Class</option>';

            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.subjectName;
                subjectSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.className;
                classSelect.appendChild(option);
            });
        }

        async function saveQuestion() {
            const questionData = {
                questionText: document.getElementById('questionText').value,
                questionType: 'multiple_choice',
                options: {
                    A: document.getElementById('optionA').value,
                    B: document.getElementById('optionB').value,
                    C: document.getElementById('optionC').value,
                    D: document.getElementById('optionD').value
                },
                correctAnswer: document.getElementById('correctOption').value,
                subjectId: document.getElementById('questionSubject').value,
                classId: document.getElementById('questionClass').value,
                marks: parseInt(document.getElementById('questionMarks').value),
                difficulty: document.getElementById('questionDifficulty').value,
                createdBy: currentStaff.userId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true
            };

            try {
                await db.collection('questions').add(questionData);
                hideModal('addQuestionModal');
                document.getElementById('addQuestionForm').reset();
                loadQuestionsData();
                showNotification('Question created successfully!', 'success');
            } catch (error) {
                console.error('Error saving question:', error);
                showNotification('Error creating question. Please try again.', 'error');
            }
        }

        function filterQuestions() {
            const subjectFilter = document.getElementById('filterSubject').value;
            const classFilter = document.getElementById('filterClass').value;
            const difficultyFilter = document.getElementById('filterDifficulty').value;

            const filteredQuestions = questions.filter(question => {
                return (!subjectFilter || question.subjectId === subjectFilter) &&
                    (!classFilter || question.classId === classFilter) &&
                    (!difficultyFilter || question.difficulty === difficultyFilter);
            });

            populateQuestionsTable(filteredQuestions);
        }

        function updateFilterDropdowns() {
            const subjectFilter = document.getElementById('filterSubject');
            const classFilter = document.getElementById('filterClass');

            if (subjectFilter) {
                subjectFilter.innerHTML = '<option value="">All Subjects</option>';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.subjectName;
                    subjectFilter.appendChild(option);
                });
            }

            if (classFilter) {
                classFilter.innerHTML = '<option value="">All Classes</option>';
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.className;
                    classFilter.appendChild(option);
                });
            }
        }

        // Batch Delete Functions
        function deleteSelectedQuestions() {
            const selectedQuestions = Array.from(selectedQuestionIds);

            if (selectedQuestions.length === 0) {
                showNotification('Please select questions to delete.', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedQuestions.length} question(s)?`)) {
                const deletePromises = selectedQuestions.map(questionId =>
                    db.collection('questions').doc(questionId).delete()
                );

                Promise.all(deletePromises)
                    .then(() => {
                        selectedQuestionIds.clear();
                        loadQuestionsData();
                        showNotification(`Successfully deleted ${selectedQuestions.length} question(s)!`, 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting questions:', error);
                        showNotification('Error deleting questions.', 'error');
                    });
            }
        }

        // Bulk Upload Functions
        function populateUploadForm() {
            const uploadSubject = document.getElementById('uploadSubject');
            const uploadClass = document.getElementById('uploadClass');

            uploadSubject.innerHTML = '<option value="">Select Subject</option>';
            uploadClass.innerHTML = '<option value="">Select Class</option>';

            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.subjectName;
                uploadSubject.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.className;
                uploadClass.appendChild(option);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUploadArea').classList.add('active');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUploadArea').classList.remove('active');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleExcelFile(files[0]);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleExcelFile(file);
            }
        }

        function handleExcelFile(file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assuming first sheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                processExcelData(jsonData);
            };

            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            uploadedQuestions = data.map((row, index) => {
                return {
                    questionText: row.Question || row.question || '',
                    options: {
                        A: row['Option A'] || row.optionA || '',
                        B: row['Option B'] || row.optionB || '',
                        C: row['Option C'] || row.optionC || '',
                        D: row['Option D'] || row.optionD || ''
                    },
                    correctAnswer: row['Correct Answer'] || row.correctAnswer || 'A'
                };
            }).filter(q => q.questionText && q.options.A && q.options.B && q.options.C && q.options.D);

            // Show preview
            showUploadPreview();
        }

        function showUploadPreview() {
            const previewTableBody = document.getElementById('previewTableBody');
            const filePreview = document.getElementById('filePreview');
            const processBtn = document.getElementById('processUploadBtn');

            if (uploadedQuestions.length === 0) {
                previewTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No valid questions found in the file</td></tr>';
                processBtn.disabled = true;
                return;
            }

            previewTableBody.innerHTML = '';
            uploadedQuestions.slice(0, 5).forEach((question, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${question.questionText.substring(0, 50)}...</td>
            <td>${question.options.A.substring(0, 20)}...</td>
            <td>${question.options.B.substring(0, 20)}...</td>
            <td>${question.options.C.substring(0, 20)}...</td>
            <td>${question.options.D.substring(0, 20)}...</td>
            <td>${question.correctAnswer}</td>
        `;
                previewTableBody.appendChild(row);
            });

            if (uploadedQuestions.length > 5) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `<td colspan="6" style="text-align: center; color: #666;">... and ${uploadedQuestions.length - 5} more questions</td>`;
                previewTableBody.appendChild(moreRow);
            }

            filePreview.style.display = 'block';
            processBtn.disabled = false;
        }

        async function processBulkUpload() {
            const subjectId = document.getElementById('uploadSubject').value;
            const classId = document.getElementById('uploadClass').value;

            if (!subjectId || !classId) {
                showNotification('Please select both subject and class.', 'error');
                return;
            }

            const processBtn = document.getElementById('processUploadBtn');
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            processBtn.disabled = true;

            try {
                let successCount = 0;
                let errorCount = 0;

                for (const questionData of uploadedQuestions) {
                    try {
                        const fullQuestionData = {
                            ...questionData,
                            questionType: 'multiple_choice',
                            subjectId: subjectId,
                            classId: classId,
                            marks: 1,
                            difficulty: 'medium',
                            createdBy: currentStaff.userId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            isActive: true
                        };

                        await db.collection('questions').add(fullQuestionData);
                        successCount++;
                    } catch (error) {
                        console.error('Error saving question:', error);
                        errorCount++;
                    }
                }

                hideModal('bulkUploadModal');
                showNotification(`Successfully uploaded ${successCount} questions. ${errorCount} failed.`, 'success');
                loadQuestionsData();
            } catch (error) {
                console.error('Error in bulk upload:', error);
                showNotification('Error processing bulk upload.', 'error');
            } finally {
                processBtn.innerHTML = 'Process Upload';
                processBtn.disabled = false;
            }
        }

        // Exams Functions
        async function loadExamsData() {
            try {
                const examsSnapshot = await db.collection('exams')
                    .where('createdBy', '==', currentStaff.userId)
                    .get();

                exams = examsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateExamsTable(exams);
            } catch (error) {
                console.error('Error loading exams data:', error);
            }
        }

        function populateExamsTable(exams) {
            const examsTableBody = document.getElementById('examsTableBody');

            if (exams.length === 0) {
                examsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No exams found</td></tr>';
                return;
            }

            examsTableBody.innerHTML = '';
            exams.forEach(exam => {
                const subject = subjects.find(s => s.id === exam.subjectId);
                const cls = classes.find(c => c.id === exam.classId);
                const now = new Date();
                const availableFrom = exam.availableFrom?.toDate();
                const availableUntil = exam.availableUntil?.toDate();

                let status = 'Upcoming';
                let statusClass = 'status-upcoming';

                if (now > availableUntil) {
                    status = 'Expired';
                    statusClass = 'status-inactive';
                } else if (now >= availableFrom && now <= availableUntil) {
                    status = 'Active';
                    statusClass = 'status-active';
                } else if (now < availableFrom) {
                    status = 'Scheduled';
                    statusClass = 'status-upcoming';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${exam.examTitle}</td>
            <td>${subject?.subjectName || exam.subjectId}</td>
            <td>${cls?.className || exam.classId}</td>
            <td>${exam.duration} mins</td>
            <td>${exam.totalQuestions}</td>
            <td>
                <span class="status-badge ${statusClass}">${status}</span>
            </td>
            <td class="action-buttons">
                <button class="action-btn btn-primary" onclick="editExam('${exam.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn btn-danger" onclick="deleteExam('${exam.id}')">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="action-btn btn-success" onclick="viewExamResults('${exam.id}')">
                    <i class="fas fa-chart-bar"></i>
                </button>
            </td>
        `;
                examsTableBody.appendChild(row);
            });
        }

        function populateExamForm() {
            const subjectSelect = document.getElementById('examSubject');
            const classSelect = document.getElementById('examClass');

            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            classSelect.innerHTML = '<option value="">Select Class</option>';

            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.subjectName;
                subjectSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.className;
                classSelect.appendChild(option);
            });

            // Set default dates
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            document.getElementById('examAvailableFrom').value = formatDateTimeLocal(now);
            document.getElementById('examAvailableUntil').value = formatDateTimeLocal(tomorrow);
        }

        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }

        async function saveExam() {
            const examData = {
                examTitle: document.getElementById('examTitle').value,
                description: document.getElementById('examDescription').value,
                subjectId: document.getElementById('examSubject').value,
                classId: document.getElementById('examClass').value,
                duration: parseInt(document.getElementById('examDuration').value),
                totalQuestions: parseInt(document.getElementById('examTotalQuestions').value),
                totalMarks: parseInt(document.getElementById('examTotalQuestions').value),
                shuffleQuestions: document.getElementById('shuffleQuestions').checked,
                allowMultipleAttempts: document.getElementById('allowMultipleAttempts').checked,
                maxAttempts: document.getElementById('allowMultipleAttempts').checked ?
                    parseInt(document.getElementById('maxAttempts').value) : 1,
                availableFrom: firebase.firestore.Timestamp.fromDate(
                    new Date(document.getElementById('examAvailableFrom').value)
                ),
                availableUntil: firebase.firestore.Timestamp.fromDate(
                    new Date(document.getElementById('examAvailableUntil').value)
                ),
                isActive: true,
                createdBy: currentStaff.userId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('exams').add(examData);
                hideModal('createExamModal');
                document.getElementById('createExamForm').reset();
                loadExamsData();
                showNotification('Exam created successfully!', 'success');
            } catch (error) {
                console.error('Error saving exam:', error);
                showNotification('Error creating exam. Please try again.', 'error');
            }
        }

        // Results & Analytics Functions
        async function loadResultsData() {
            try {
                const examsSnapshot = await db.collection('exams')
                    .where('createdBy', '==', currentStaff.userId)
                    .get();

                populateResultsDropdowns(examsSnapshot);
            } catch (error) {
                console.error('Error loading results data:', error);
            }
        }

        function populateResultsDropdowns(examsSnapshot) {
            const examSelect = document.getElementById('resultsExam');
            const classSelect = document.getElementById('resultsClass');

            examSelect.innerHTML = '<option value="">Select Exam</option>';
            classSelect.innerHTML = '<option value="">All Classes</option>';

            examsSnapshot.forEach(doc => {
                const exam = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = exam.examTitle;
                examSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.className;
                classSelect.appendChild(option);
            });
        }

        async function generateReport() {
            const examId = document.getElementById('resultsExam').value;
            const classId = document.getElementById('resultsClass').value;

            if (!examId) {
                showNotification('Please select an exam to generate report.', 'error');
                return;
            }

            try {
                let query = db.collection('results').where('examId', '==', examId);

                if (classId) {
                    // Get students in the selected class
                    const studentsSnapshot = await db.collection('users')
                        .where('role', '==', 'student')
                        .where('class', '==', classId)
                        .get();

                    const studentIds = studentsSnapshot.docs.map(doc => doc.id);
                    query = query.where('studentId', 'in', studentIds);
                }

                const resultsSnapshot = await query.get();
                results = resultsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                displayResultsReport(results);
                generatePerformanceChart(results);
            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Error generating report. Please try again.', 'error');
            }
        }

        function displayResultsReport(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');

            if (results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No results found for the selected criteria</td></tr>';
                return;
            }

            resultsTableBody.innerHTML = '';

            // Sort by percentage (descending)
            results.sort((a, b) => b.percentage - a.percentage);

            results.forEach(async (result, index) => {
                // Get student details
                const studentSnapshot = await db.collection('users').doc(result.studentId).get();
                const student = studentSnapshot.data();

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${student?.firstName} ${student?.lastName}</td>
            <td>${student?.admissionNumber}</td>
            <td>${result.score}/${result.totalQuestions}</td>
            <td>${result.percentage}%</td>
            <td>${calculateGrade(result.percentage)}</td>
            <td>${Math.floor(result.timeSpent / 60)}:${(result.timeSpent % 60).toString().padStart(2, '0')}</td>
            <td>${result.submittedAt?.toDate().toLocaleDateString()}</td>
        `;
                resultsTableBody.appendChild(row);
            });
        }

        function generatePerformanceChart(results) {
            const chartContainer = document.getElementById('performanceChart');

            if (results.length === 0) {
                chartContainer.innerHTML = '<p>No data available for chart</p>';
                return;
            }

            // Simple chart using HTML/CSS
            const gradeCounts = {
                A: 0, B: 0, C: 0, D: 0, F: 0
            };

            results.forEach(result => {
                const grade = calculateGrade(result.percentage);
                gradeCounts[grade]++;
            });

            const total = results.length;
            const chartHTML = `
        <div style="display: flex; height: 100%; align-items: end; gap: 10px; padding: 20px;">
            ${Object.entries(gradeCounts).map(([grade, count]) => `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div style="background: var(--${getGradeColor(grade)}); width: 80%; height: ${(count / total) * 200}px; border-radius: 5px 5px 0 0;"></div>
                    <div style="margin-top: 10px; font-weight: bold;">${grade}</div>
                    <div style="font-size: 0.8em; color: #666;">${count}</div>
                </div>
            `).join('')}
        </div>
    `;

            chartContainer.innerHTML = chartHTML;
        }

        function calculateGrade(percentage) {
            if (!currentSettings?.gradingSystem) return 'F';

            const { gradingSystem } = currentSettings;
            if (percentage >= gradingSystem.A.min) return 'A';
            if (percentage >= gradingSystem.B.min) return 'B';
            if (percentage >= gradingSystem.C.min) return 'C';
            if (percentage >= gradingSystem.D.min) return 'D';
            return 'F';
        }

        function getGradeColor(grade) {
            const colors = {
                A: 'success',
                B: 'accent',
                C: 'warning',
                D: 'secondary',
                F: 'danger'
            };
            return colors[grade] || 'danger';
        }

        // Profile Functions
        function loadProfileData() {
            // Populate profile form
            document.getElementById('profileFirstName').value = currentStaff.firstName;
            document.getElementById('profileLastName').value = currentStaff.lastName;
            document.getElementById('profileEmail').value = currentStaff.email;
        }

        async function updateProfile(e) {
            e.preventDefault();

            const profileData = {
                firstName: document.getElementById('profileFirstName').value,
                lastName: document.getElementById('profileLastName').value,
                email: document.getElementById('profileEmail').value
            };

            try {
                await db.collection('users').doc(currentStaff.userId).update(profileData);

                // Update current staff data
                currentStaff = { ...currentStaff, ...profileData };
                localStorage.setItem('staffUser', JSON.stringify(currentStaff));

                showStaffInterface(); // Refresh the name in top bar
                showNotification('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile. Please try again.', 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match.', 'error');
                return;
            }

            if (currentPassword !== currentStaff.password) {
                showNotification('Current password is incorrect.', 'error');
                return;
            }

            try {
                await db.collection('users').doc(currentStaff.userId).update({
                    password: newPassword,
                    mustChangePassword: false
                });

                // Update current staff data
                currentStaff.password = newPassword;
                currentStaff.mustChangePassword = false;
                localStorage.setItem('staffUser', JSON.stringify(currentStaff));

                document.getElementById('passwordForm').reset();
                showNotification('Password changed successfully!', 'success');
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('Error changing password. Please try again.', 'error');
            }
        }

        // Utility Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;

            const bgColors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };

            notification.style.backgroundColor = bgColors[type] || bgColors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 5000);
        }

        // Placeholder functions for edit operations
        // Replace the placeholder functions with these complete implementations:

        // Edit Question Function
        async function editQuestion(questionId) {
            try {
                const questionDoc = await db.collection('questions').doc(questionId).get();
                if (!questionDoc.exists) {
                    showNotification('Question not found!', 'error');
                    return;
                }

                const question = questionDoc.data();

                // Check if the question belongs to the current staff
                if (question.createdBy !== currentStaff.userId) {
                    showNotification('You are not authorized to edit this question.', 'error');
                    return;
                }

                // Load subjects and classes first
                await loadSubjectsAndClasses();

                // Populate the form with question data
                document.getElementById('questionText').value = question.questionText;
                document.getElementById('questionSubject').value = question.subjectId;
                document.getElementById('questionClass').value = question.classId;
                document.getElementById('questionMarks').value = question.marks;
                document.getElementById('questionDifficulty').value = question.difficulty;
                document.getElementById('optionA').value = question.options.A;
                document.getElementById('optionB').value = question.options.B;
                document.getElementById('optionC').value = question.options.C;
                document.getElementById('optionD').value = question.options.D;
                document.getElementById('correctOption').value = question.correctAnswer;

                // Store the question ID for updating
                window.editingQuestionId = questionId;

                // Change modal title and button text
                document.querySelector('#addQuestionModal .modal-title').textContent = 'Edit Question';
                document.getElementById('saveQuestionBtn').textContent = 'Update Question';

                showModal('addQuestionModal');
            } catch (error) {
                console.error('Error loading question for editing:', error);
                showNotification('Error loading question data', 'error');
            }
        }

        // Edit Exam Function
        async function editExam(examId) {
            try {
                const examDoc = await db.collection('exams').doc(examId).get();
                if (!examDoc.exists) {
                    showNotification('Exam not found!', 'error');
                    return;
                }

                const exam = examDoc.data();

                // Check if the exam belongs to the current staff
                if (exam.createdBy !== currentStaff.userId) {
                    showNotification('You are not authorized to edit this exam.', 'error');
                    return;
                }

                // Load subjects and classes first
                await loadSubjectsAndClasses();

                // Populate the form with exam data
                document.getElementById('examTitle').value = exam.examTitle;
                document.getElementById('examDescription').value = exam.description || '';
                document.getElementById('examSubject').value = exam.subjectId;
                document.getElementById('examClass').value = exam.classId;
                document.getElementById('examDuration').value = exam.duration;
                document.getElementById('examTotalQuestions').value = exam.totalQuestions;
                document.getElementById('shuffleQuestions').checked = exam.shuffleQuestions || false;
                document.getElementById('allowMultipleAttempts').checked = exam.allowMultipleAttempts || false;
                document.getElementById('maxAttempts').value = exam.maxAttempts || 1;

                // Convert Firestore timestamps to datetime-local format
                const availableFrom = exam.availableFrom?.toDate();
                const availableUntil = exam.availableUntil?.toDate();

                if (availableFrom) {
                    document.getElementById('examAvailableFrom').value = formatDateTimeLocal(availableFrom);
                }
                if (availableUntil) {
                    document.getElementById('examAvailableUntil').value = formatDateTimeLocal(availableUntil);
                }

                // Show/hide max attempts container based on multiple attempts setting
                document.getElementById('maxAttemptsContainer').style.display =
                    exam.allowMultipleAttempts ? 'block' : 'none';

                // Store the exam ID for updating
                window.editingExamId = examId;

                // Change modal title and button text
                document.querySelector('#createExamModal .modal-title').textContent = 'Edit Exam';
                document.getElementById('saveExamBtn').textContent = 'Update Exam';

                showModal('createExamModal');
            } catch (error) {
                console.error('Error loading exam for editing:', error);
                showNotification('Error loading exam data', 'error');
            }
        }

        // Update the saveQuestion function to handle both create and update:
        async function saveQuestion() {
            const questionData = {
                questionText: document.getElementById('questionText').value,
                questionType: 'multiple_choice',
                options: {
                    A: document.getElementById('optionA').value,
                    B: document.getElementById('optionB').value,
                    C: document.getElementById('optionC').value,
                    D: document.getElementById('optionD').value
                },
                correctAnswer: document.getElementById('correctOption').value,
                subjectId: document.getElementById('questionSubject').value,
                classId: document.getElementById('questionClass').value,
                marks: parseInt(document.getElementById('questionMarks').value),
                difficulty: document.getElementById('questionDifficulty').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true
            };

            try {
                if (window.editingQuestionId) {
                    // Update existing question
                    await db.collection('questions').doc(window.editingQuestionId).update(questionData);
                    showNotification('Question updated successfully!', 'success');
                } else {
                    // Create new question
                    questionData.createdBy = currentStaff.userId;
                    questionData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('questions').add(questionData);
                    showNotification('Question created successfully!', 'success');
                }

                hideModal('addQuestionModal');
                resetQuestionForm();
                loadQuestionsData();

            } catch (error) {
                console.error('Error saving question:', error);
                showNotification('Error saving question. Please try again.', 'error');
            }
        }

        // Update the saveExam function to handle both create and update:
        async function saveExam() {
            const examData = {
                examTitle: document.getElementById('examTitle').value,
                description: document.getElementById('examDescription').value,
                subjectId: document.getElementById('examSubject').value,
                classId: document.getElementById('examClass').value,
                duration: parseInt(document.getElementById('examDuration').value),
                totalQuestions: parseInt(document.getElementById('examTotalQuestions').value),
                totalMarks: parseInt(document.getElementById('examTotalQuestions').value),
                shuffleQuestions: document.getElementById('shuffleQuestions').checked,
                allowMultipleAttempts: document.getElementById('allowMultipleAttempts').checked,
                maxAttempts: document.getElementById('allowMultipleAttempts').checked ?
                    parseInt(document.getElementById('maxAttempts').value) : 1,
                availableFrom: firebase.firestore.Timestamp.fromDate(
                    new Date(document.getElementById('examAvailableFrom').value)
                ),
                availableUntil: firebase.firestore.Timestamp.fromDate(
                    new Date(document.getElementById('examAvailableUntil').value)
                ),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true
            };

            try {
                if (window.editingExamId) {
                    // Update existing exam
                    await db.collection('exams').doc(window.editingExamId).update(examData);
                    showNotification('Exam updated successfully!', 'success');
                } else {
                    // Create new exam
                    examData.createdBy = currentStaff.userId;
                    examData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('exams').add(examData);
                    showNotification('Exam created successfully!', 'success');
                }

                hideModal('createExamModal');
                resetExamForm();
                loadExamsData();

            } catch (error) {
                console.error('Error saving exam:', error);
                showNotification('Error saving exam. Please try again.', 'error');
            }
        }

        // Add these reset functions:
        function resetQuestionForm() {
            document.getElementById('addQuestionForm').reset();
            window.editingQuestionId = null;
            document.querySelector('#addQuestionModal .modal-title').textContent = 'Add Question';
            document.getElementById('saveQuestionBtn').textContent = 'Save Question';
        }

        function resetExamForm() {
            document.getElementById('createExamForm').reset();
            window.editingExamId = null;
            document.querySelector('#createExamModal .modal-title').textContent = 'Create New Exam';
            document.getElementById('saveExamBtn').textContent = 'Create Exam';

            // Set default dates
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('examAvailableFrom').value = formatDateTimeLocal(now);
            document.getElementById('examAvailableUntil').value = formatDateTimeLocal(tomorrow);

            // Reset multiple attempts UI
            document.getElementById('maxAttemptsContainer').style.display = 'none';
        }

        // Update the modal cancel buttons to also reset the forms:
        document.getElementById('cancelQuestionBtn')?.addEventListener('click', () => {
            hideModal('addQuestionModal');
            resetQuestionForm();
        });

        document.getElementById('cancelExamBtn')?.addEventListener('click', () => {
            hideModal('createExamModal');
            resetExamForm();
        });

        // Also reset forms when modal is closed via X button or clicking outside
        document.querySelectorAll('.modal-close').forEach(closeBtn => {
            closeBtn.addEventListener('click', (e) => {
                const modal = closeBtn.closest('.modal');
                if (modal.id === 'addQuestionModal') {
                    resetQuestionForm();
                } else if (modal.id === 'createExamModal') {
                    resetExamForm();
                }
                modal.classList.remove('active');
            });
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    if (modal.id === 'addQuestionModal') {
                        resetQuestionForm();
                    } else if (modal.id === 'createExamModal') {
                        resetExamForm();
                    }
                    modal.classList.remove('active');
                }
            });
        });

        function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                db.collection('questions').doc(questionId).delete()
                    .then(() => {
                        loadQuestionsData();
                        showNotification('Question deleted successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting question:', error);
                        showNotification('Error deleting question.', 'error');
                    });
            }
        }

        function deleteExam(examId) {
            if (confirm('Are you sure you want to delete this exam?')) {
                db.collection('exams').doc(examId).delete()
                    .then(() => {
                        loadExamsData();
                        showNotification('Exam deleted successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting exam:', error);
                        showNotification('Error deleting exam.', 'error');
                    });
            }
        }

        function viewExamResults(examId) {
            document.getElementById('resultsExam').value = examId;
            document.querySelector('.menu-item[data-section="results"]').click();
            setTimeout(() => {
                generateReport();
            }, 500);
        }
    </script>
</body>

</html>