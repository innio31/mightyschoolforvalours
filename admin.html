<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results Admin - The Climax Model Schools, Ota</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #1a5fb4;
            --secondary-color: #f6d32d;
            --accent-color: #1a5fb4;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .badge-primary {
            background-color: var(--primary-color);
        }

        .badge-secondary {
            background-color: var(--secondary-color);
            color: #333;
        }

        .filter-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .high-score {
            color: #28a745;
            font-weight: 600;
        }

        .medium-score {
            color: #ffc107;
            font-weight: 600;
        }

        .low-score {
            color: #dc3545;
            font-weight: 600;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
        }

        .school-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0d47a1 100%);
            color: white;
            padding: 15px 0;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .school-logo {
            width: 80px;
            height: 80px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: var(--primary-color);
            border: 3px solid var(--secondary-color);
        }

        .theory-grading-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .theory-answers .card {
            border: 1px solid #dee2e6;
        }

        .theory-answers .card-header {
            background-color: #f8f9fa;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .school-logo {
                width: 60px;
                height: 60px;
                font-size: 0.8rem;
                margin-right: 10px;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.3rem;
            }

            .card-header {
                padding: 10px 15px;
            }

            .table-responsive {
                font-size: 0.85rem;
            }

            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <!-- School Header -->
        <div class="school-header">
            <div class="row align-items-center">
                <div class="col-md-8 d-flex align-items-center">
                    <div class="school-logo">
                        <span>TCMS</span>
                    </div>
                    <div>
                        <h1 class="mb-0">The Climax Model Schools, Ota</h1>
                        <p class="mb-0">Stand Out and Lead</p>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <button id="exportBtn" class="btn btn-light">
                        <i class="fas fa-file-export me-2"></i>Export to Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Exam Portal Management -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cog me-2"></i>Exam Portal Management
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="toggleExamPortal"
                                        style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label" for="toggleExamPortal">
                                        <h5>Exam Portal Status</h5>
                                        <p class="text-muted">Toggle to open/close the exam portal for students</p>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Available Exam Types</label>
                                    <div class="form-check">
                                        <input class="form-check-input exam-type-check" type="checkbox" value="ca"
                                            id="examTypeCA">
                                        <label class="form-check-label" for="examTypeCA">
                                            Continuous Assessment (CA)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input exam-type-check" type="checkbox" value="midterm"
                                            id="examTypeMidterm">
                                        <label class="form-check-label" for="examTypeMidterm">
                                            Midterm Exam
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input exam-type-check" type="checkbox" value="exam"
                                            id="examTypeFinal">
                                        <label class="form-check-label" for="examTypeFinal">
                                            End of Term Exam
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="examStartDate" class="form-label">Start Date</label>
                                    <input type="datetime-local" class="form-control" id="examStartDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="examEndDate" class="form-label">End Date</label>
                                    <input type="datetime-local" class="form-control" id="examEndDate">
                                </div>
                            </div>
                        </div>
                        <button id="saveExamSettings" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Term Report Generation -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-2"></i>Term Report Generation
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Class</label>
                                    <select class="form-select" id="reportClass">
                                        <option value="">Select Class</option>
                                        <option value="jss1">JSS 1</option>
                                        <option value="jss2">JSS 2</option>
                                        <option value="jss3">JSS 3</option>
                                        <option value="sss1">SSS 1</option>
                                        <option value="sss2">SSS 2</option>
                                        <option value="sss3">SSS 3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Term</label>
                                    <select class="form-select" id="reportTerm">
                                        <option value="">Select Term</option>
                                        <option value="1st">1st Term</option>
                                        <option value="2nd">2nd Term</option>
                                        <option value="3rd">3rd Term</option>
                                        <option value="summer">Summer Term</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Session</label>
                                    <select class="form-select" id="reportSession">
                                        <option value="">Select Session</option>
                                        <option value="2022_2023">2022/2023</option>
                                        <option value="2023_2024">2023/2024</option>
                                        <option value="2024_2025">2024/2025</option>
                                        <option value="2025_2026">2025/2026</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3" id="weightInputs">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="caWeight" class="form-label">CA Weight (%)</label>
                                    <input type="number" class="form-control" id="caWeight" value="10" min="0"
                                        max="100">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="midtermWeight" class="form-label">Midterm Weight (%)</label>
                                    <input type="number" class="form-control" id="midtermWeight" value="20" min="0"
                                        max="100">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="examWeight" class="form-label">Exam Weight (%)</label>
                                    <input type="number" class="form-control" id="examWeight" value="70" min="0"
                                        max="100">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button id="previewReport" class="btn btn-primary">
                                <i class="fas fa-eye me-2"></i>Preview Report
                            </button>
                            <button id="generatePdf" class="btn btn-success">
                                <i class="fas fa-file-pdf me-2"></i>Generate PDF
                            </button>
                        </div>

                        <div id="reportPreview" class="mt-4 d-none">
                            <div class="card">
                                <div class="card-header">
                                    Report Preview
                                </div>
                                <div class="card-body" id="previewContent">
                                    <!-- Preview content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-container mt-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Class</label>
                    <select class="form-select" id="filterClass">
                        <option value="">All Classes</option>
                        <option value="jss1">JSS 1</option>
                        <option value="jss2">JSS 2</option>
                        <option value="jss3">JSS 3</option>
                        <option value="sss1">SSS 1</option>
                        <option value="sss2">SSS 2</option>
                        <option value="sss3">SSS 3</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Subject</label>
                    <select class="form-select" id="filterSubject">
                        <option value="">All Subjects</option>
                        <option value="mathematics">Mathematics</option>
                        <option value="english">English Language</option>
                        <option value="physics">Physics</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="biology">Biology</option>
                        <option value="agricultural-science">Agricultural Science</option>
                        <option value="further-mathematics">Further Mathematics</option>
                        <option value="basic-science">Basic Science</option>
                        <option value="basic-technology">Basic Technology</option>
                        <option value="civic-education">Civic Education</option>
                        <option value="economics">Economics</option>
                        <option value="commerce">Commerce</option>
                        <option value="accounting">Financial Accounting</option>
                        <option value="government">Government</option>
                        <option value="geography">Geography</option>
                        <option value="history">History</option>
                        <option value="literature-in-english">Literature in English</option>
                        <option value="christian-religious-studies">Christian Religious Studies (CRS)</option>
                        <option value="islamic-studies">Islamic Studies</option>
                        <option value="social-studies">Social Studies</option>
                        <option value="computer-science">Computer Science / ICT</option>
                        <option value="home-economics">Home Economics</option>
                        <option value="physical-and-health-education">Physical & Health Education (PHE)</option>
                        <option value="technical-drawing">Technical Drawing</option>
                        <option value="fine-arts">Fine Arts / Visual Arts</option>
                        <option value="music">Music</option>
                        <option value="french">French</option>
                        <option value="arabic">Arabic</option>
                        <option value="yoruba">Yoruba</option>
                        <option value="igbo">Igbo</option>
                        <option value="hausa">Hausa</option>
                        <option value="business-studies">Business Studies</option>
                        <option value="food-and-nutrition">Food & Nutrition</option>
                        <option value="woodwork">Woodwork</option>
                        <option value="metalwork">Metalwork</option>
                        <option value="building-construction">Building Construction</option>
                        <option value="auto-mechanics">Auto Mechanics</option>
                        <option value="electronics">Electronics</option>
                        <option value="insurance">Insurance</option>
                        <option value="marketing">Marketing</option>
                        <option value="tourism">Tourism</option>
                        <option value="general-science">General Science</option>
                        <option value="entrepreneurship">Entrepreneurship</option>
                        <option value="cultural-and-creative-arts">Cultural & Creative Arts</option>
                        <option value="library-studies">Library Studies</option>
                        <option value="data-processing">Data Processing</option>
                        <option value="office-practice">Office Practice</option>
                        <option value="book-keeping">Book Keeping</option>

                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Exam Type</label>
                    <select class="form-select" id="filterExamType">
                        <option value="">All Types</option>
                        <option value="ca">Continuous Assessment</option>
                        <option value="midterm">Midterm Exam</option>
                        <option value="exam">End of Term Exam</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Term</label>
                    <select class="form-select" id="filterTerm">
                        <option value="">All Terms</option>
                        <option value="1st">1st Term</option>
                        <option value="2nd">2nd Term</option>
                        <option value="3rd">3rd Term</option>
                        <option value="summer">Summer Term</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="d-flex justify-content-end gap-2">
                        <button id="applyFilters" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                        <button id="resetFilters" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Results -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Exam Results</span>
                        <div>
                            <span class="badge bg-secondary me-2">Total: <span id="totalResults">0</span></span>
                            <span class="badge bg-primary">Avg Score: <span id="averageScore">0</span>%</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Exam Type</th>
                                        <th>Term/Session</th>
                                        <th>Score</th>
                                        <th>Theory</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable">
                                    <tr>
                                        <td colspan="9" class="text-center py-4">Loading data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be added here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Performance Summary
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="250"></canvas>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        Score Distribution
                    </div>
                    <div class="card-body">
                        <canvas id="scoreChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Performance Trends
                    </div>
                    <div class="card-body">
                        <canvas id="trendsChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Details Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exam Result Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="resultDetails">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printResult">Print Result</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ===== Password Protection =====
        const PASSWORD = "mvs123"; // change as needed
        (function () {
            let entered = prompt("Enter Password:");
            if (entered !== PASSWORD) {
                alert("Access Denied");
                window.location.reload();
            }
        })();
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDDJln5uWh_xmDA7bXowbFT-yL6zlBPtRg",
            authDomain: "mightyschoolforvalours-91aa4.firebaseapp.com",
            projectId: "mightyschoolforvalours-91aa4",
            storageBucket: "mightyschoolforvalours-91aa4.firebasestorage.app",
            messagingSenderId: "778024125256",
            appId: "1:778024125256:web:31d482406bf06a2125a97d",
            measurementId: "G-C2NY58GRFT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let allResults = [];
        let filteredResults = [];
        let currentPage = 1;
        const resultsPerPage = 10;
        let performanceChart, scoreChart, trendsChart;
        let examSettings = {
            isExamOpen: false,
            availableExamTypes: [],
            startDate: null,
            endDate: null
        };
        let currentReportData = null;

        // DOM Elements
        const resultsTable = document.getElementById('resultsTable');
        const totalResults = document.getElementById('totalResults');
        const averageScore = document.getElementById('averageScore');
        const exportBtn = document.getElementById('exportBtn');
        const applyFilters = document.getElementById('applyFilters');
        const resetFilters = document.getElementById('resetFilters');
        const printResult = document.getElementById('printResult');
        const toggleExamPortal = document.getElementById('toggleExamPortal');
        const examTypeCheckboxes = document.querySelectorAll('.exam-type-check');
        const examStartDate = document.getElementById('examStartDate');
        const examEndDate = document.getElementById('examEndDate');
        const saveExamSettingsBtn = document.getElementById('saveExamSettings');
        const previewReportBtn = document.getElementById('previewReport');
        const generatePdfBtn = document.getElementById('generatePdf');
        const reportTerm = document.getElementById('reportTerm');
        const weightInputs = document.getElementById('weightInputs');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            loadResults();
            loadExamSettings();

            // Event listeners
            applyFilters.addEventListener('click', applyResultsFilters);
            resetFilters.addEventListener('click', resetResultsFilters);
            exportBtn.addEventListener('click', exportToExcel);
            printResult.addEventListener('click', printResultDetails);
            saveExamSettingsBtn.addEventListener('click', saveExamSettings);
            previewReportBtn.addEventListener('click', previewTermReport);
            generatePdfBtn.addEventListener('click', generateTermReportPdf);

            // Show/hide weight inputs based on term selection
            reportTerm.addEventListener('change', function () {
                if (this.value === 'summer') {
                    weightInputs.classList.add('d-none');
                    document.getElementById('caWeight').value = '0';
                    document.getElementById('midtermWeight').value = '0';
                    document.getElementById('examWeight').value = '100';
                } else {
                    weightInputs.classList.remove('d-none');
                    document.getElementById('caWeight').value = '10';
                    document.getElementById('midtermWeight').value = '20';
                    document.getElementById('examWeight').value = '70';
                }
            });
        });

        // ==================== RESULTS MANAGEMENT ====================

        // Load results from Firebase
        function loadResults() {
            const resultsRef = database.ref('examResults');

            resultsRef.on('value', (snapshot) => {
                allResults = [];
                let totalScore = 0;
                let resultCount = 0;

                snapshot.forEach(childSnapshot => {
                    const result = childSnapshot.val();
                    result.id = childSnapshot.key;

                    if (!result.timestamp) {
                        result.timestamp = result.submittedAt || new Date().toISOString();
                    }

                    // Calculate total score if theory is graded
                    if (result.theoryGraded && result.theoryScore !== undefined) {
                        if (result.examType === 'ca') {
                            result.totalScore = ((result.objectiveScore || 0) * 0.5) + (result.theoryScore * 0.5);
                        } else if (result.examType === 'midterm') {
                            result.totalScore = ((result.objectiveScore || 0) * 0.5) + (result.theoryScore * 0.5);
                        } else if (result.examType === 'exam') {
                            result.totalScore = ((result.objectiveScore || 0) * 0.3) + (result.theoryScore * 0.7);
                        } else {
                            result.totalScore = result.objectiveScore || 0;
                        }
                    } else {
                        result.totalScore = result.objectiveScore || 0;
                    }

                    allResults.push(result);

                    if (result.totalScore) {
                        totalScore += result.totalScore;
                        resultCount++;
                    }
                });

                allResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                filteredResults = [...allResults];
                updateResultsTable();
                updateCharts();

                const avg = resultCount > 0 ? Math.round(totalScore / resultCount) : 0;
                averageScore.textContent = avg;
                totalResults.textContent = allResults.length;
            }, (error) => {
                console.error("Database read failed:", error);
                resultsTable.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-danger">
                            Failed to load results. Please check console for details.
                        </td>
                    </tr>
                `;
            });
        }

        // Update results table
        function updateResultsTable(page = 1) {
            currentPage = page;
            const startIndex = (page - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const paginatedResults = filteredResults.slice(startIndex, endIndex);

            // Clear existing rows
            resultsTable.innerHTML = '';

            if (paginatedResults.length === 0) {
                resultsTable.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">No results found matching your criteria</td>
                    </tr>
                `;
            } else {
                // Add new rows
                paginatedResults.forEach(result => {
                    const row = document.createElement('tr');
                    row.className = 'result-row';

                    // Format date
                    const submittedDate = formatDate(result.timestamp);

                    // Get score class
                    const scoreClass = getScoreClass(result.totalScore);

                    row.innerHTML = `
                        <td>${result.name || 'N/A'}</td>
                        <td>${result.class ? result.class.toUpperCase() : 'N/A'}</td>
                        <td>${result.subject ? capitalizeFirstLetter(result.subject) : 'N/A'}</td>
                        <td>${getExamTypeDisplay(result.examType)}</td>
                        <td>${result.term ? `${result.term} Term` : ''} ${result.session || ''}</td>
                        <td class="${scoreClass}">
                            ${result.totalScore || result.totalScore === 0 ? Math.round(result.totalScore) + '%' : 'N/A'}
                        </td>
                        <td>
                            ${result.theoryGraded ?
                            `<span class="badge bg-success">Graded: ${result.theoryScore}%</span>` :
                            result.theorySubmitted ?
                                `<span class="badge bg-warning text-dark">Pending</span>` :
                                `<span class="badge bg-secondary">Not Submitted</span>`}
                        </td>
                        <td>${submittedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-details" data-id="${result.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    resultsTable.appendChild(row);
                });

                // Add event listeners to view buttons
                document.querySelectorAll('.view-details').forEach(btn => {
                    btn.addEventListener('click', () => viewResultDetails(btn.dataset.id));
                });
            }

            // Update pagination
            updatePagination();
        }

        // View detailed result
        function viewResultDetails(resultId) {
            const result = allResults.find(r => r.id === resultId);
            if (!result) return;

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            const detailsContainer = document.getElementById('resultDetails');

            // Store the current result ID in the modal for later reference
            document.getElementById('resultModal').dataset.currentResultId = resultId;

            // Calculate score breakdown
            let objectiveContribution = 0;
            let theoryContribution = 0;

            if (result.examType === 'ca') {
                objectiveContribution = (result.objectiveScore || 0) * 0.5;
                theoryContribution = result.theoryGraded ? (result.theoryScore * 0.5) : 0;
            } else if (result.examType === 'midterm') {
                objectiveContribution = (result.objectiveScore || 0) * 0.5;
                theoryContribution = result.theoryGraded ? (result.theoryScore * 0.5) : 0;
            } else if (result.examType === 'exam') {
                objectiveContribution = (result.objectiveScore || 0) * 0.3;
                theoryContribution = result.theoryGraded ? (result.theoryScore * 0.7) : 0;
            } else {
                objectiveContribution = result.objectiveScore || 0;
            }

            // Format the details HTML
            detailsContainer.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>Student Information</h5>
                <p><strong>Name:</strong> ${result.name || 'N/A'}</p>
                <p><strong>Class:</strong> ${result.class ? result.class.toUpperCase() : 'N/A'}</p>
                <p><strong>Student ID:</strong> ${result.studentId || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h5>Exam Information</h5>
                <p><strong>Subject:</strong> ${result.subject ? capitalizeFirstLetter(result.subject) : 'N/A'}</p>
                <p><strong>Exam Type:</strong> ${getExamTypeDisplay(result.examType)}</p>
                <p><strong>Term/Session:</strong> ${result.term ? `${result.term} Term` : ''} ${result.session || ''}</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        Objective Section
                    </div>
                    <div class="card-body">
                        <h3 class="${getScoreClass(result.objectiveScore)}">
                            ${result.objectiveScore || result.objectiveScore === 0 ? result.objectiveScore + '%' : 'N/A'}
                        </h3>
                        <p class="card-text">Contribution: ${Math.round(objectiveContribution)}%</p>
                        <p class="card-text">Automatically graded</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header ${result.theorySubmitted ? (result.theoryGraded ? 'bg-success text-white' : 'bg-warning text-dark') : 'bg-secondary text-white'}">
                        Theory Section
                    </div>
                    <div class="card-body">
                        ${result.theoryGraded ? `
                            <h3 class="${getScoreClass(result.theoryScore)}">
                                ${result.theoryScore}%
                            </h3>
                            <p class="card-text">Contribution: ${Math.round(theoryContribution)}%</p>
                            <p class="card-text">Graded by: ${result.theoryGradedBy || 'Teacher'}</p>
                            <p class="card-text">Graded on: ${formatDate(result.theoryGradedAt)}</p>
                            <button class="btn btn-sm btn-warning mt-2" id="editTheoryScore">
                                <i class="fas fa-edit me-1"></i>Edit Score
                            </button>
                        ` : result.theorySubmitted ? `
                            <div class="theory-grading-form">
                                <h5>Grade Theory Section</h5>
                                <div class="mb-3">
                                    <label for="theoryScoreInput" class="form-label">Theory Score (0-100)</label>
                                    <input type="number" class="form-control" id="theoryScoreInput" min="0" max="100" placeholder="Enter score">
                                </div>
                                <div class="mb-3">
                                    <label for="theoryGraderName" class="form-label">Grader Name</label>
                                    <input type="text" class="form-control" id="theoryGraderName" placeholder="Your name">
                                </div>
                                <div class="mb-3">
                                    <label for="theoryComments" class="form-label">Comments (Optional)</label>
                                    <textarea class="form-control" id="theoryComments" rows="2" placeholder="Any comments about this theory submission"></textarea>
                                </div>
                                <button class="btn btn-success" id="saveTheoryScore">Save Theory Score</button>
                            </div>
                        ` : `
                            <p class="card-text">Not submitted</p>
                        `}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4>Total Score: <span class="${getScoreClass(result.totalScore)}">${Math.round(result.totalScore)}%</span></h4>
                        <p class="mb-0">Objective: ${Math.round(objectiveContribution)}% + Theory: ${Math.round(theoryContribution)}%</p>
                    </div>
                </div>
            </div>
        </div>
        
        ${result.answers ? `
        <div class="mt-4">
            <h5>Objective Answers</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Selected Answer</th>
                            <th>Correct</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.answers.map((answer, index) => `
                            <tr>
                                <td>Question ${index + 1}</td>
                                <td>${answer !== null ? `Option ${String.fromCharCode(65 + answer)}` : 'Not answered'}</td>
                                <td>${result.correctAnswers && result.correctAnswers[index] !== undefined ?
                    (answer === result.correctAnswers[index] ?
                        '<span class="text-success"><i class="fas fa-check"></i></span>' :
                        '<span class="text-danger"><i class="fas fa-times"></i></span>') :
                    'N/A'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
        
        ${result.theoryAnswers ? `
        <div class="mt-4">
            <h5>Theory Answers</h5>
            <div class="theory-answers">
                ${result.theoryAnswers.map((answer, index) => `
                    <div class="card mb-2">
                        <div class="card-header py-1">
                            <strong>Question ${index + 1}</strong>
                        </div>
                        <div class="card-body py-2">
                            <p class="mb-0">${answer || 'No answer provided'}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
    `;

            // Add event listeners to buttons
            setTimeout(() => {
                const saveBtn = document.getElementById('saveTheoryScore');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveTheoryScore);
                }

                const editBtn = document.getElementById('editTheoryScore');
                if (editBtn) {
                    editBtn.addEventListener('click', showEditTheoryScoreForm);
                }
            }, 100);

            modal.show();
        }

        // Function to save theory score
        function saveTheoryScore() {
            const modal = document.getElementById('resultModal');
            const resultId = modal.dataset.currentResultId;

            if (!resultId) {
                showAlert('danger', 'No result selected for theory score update');
                return;
            }

            // Get input values
            const theoryScoreInput = document.getElementById('theoryScoreInput');
            const graderNameInput = document.getElementById('theoryGraderName');
            const commentsInput = document.getElementById('theoryComments');

            const theoryScore = parseInt(theoryScoreInput.value);
            const graderName = graderNameInput.value.trim();
            const comments = commentsInput.value.trim();

            // Validate inputs
            if (isNaN(theoryScore) || theoryScore < 0 || theoryScore > 100) {
                showAlert('danger', 'Please enter a valid theory score between 0 and 100');
                return;
            }

            if (!graderName) {
                showAlert('danger', 'Please enter your name as the grader');
                return;
            }

            // Find the result to update
            const result = allResults.find(r => r.id === resultId);
            if (!result) return;

            // Calculate new total score based on exam type
            let totalScore = result.objectiveScore || 0;

            if (result.examType === 'ca') {
                totalScore = (result.objectiveScore * 0.5) + (theoryScore * 0.5);
            } else if (result.examType === 'midterm') {
                totalScore = (result.objectiveScore * 0.5) + (theoryScore * 0.5);
            } else if (result.examType === 'exam') {
                totalScore = (result.objectiveScore * 0.3) + (theoryScore * 0.7);
            }

            // Update the result in Firebase
            const resultRef = database.ref('examResults/' + resultId);
            const updates = {
                theoryScore: theoryScore,
                theoryGraded: true,
                theoryGradedBy: graderName,
                theoryGradedAt: new Date().toISOString(),
                totalScore: totalScore
            };

            // Add comments if provided
            if (comments) {
                updates.theoryComments = comments;
            }

            resultRef.update(updates)
                .then(() => {
                    showAlert('success', 'Theory score saved successfully!');
                    // Close the modal and reload results
                    bootstrap.Modal.getInstance(modal).hide();
                    loadResults();
                })
                .catch(error => {
                    console.error('Error saving theory score:', error);
                    showAlert('danger', 'Failed to save theory score.');
                });
        }

        // Function to show edit theory score form
        function showEditTheoryScoreForm() {
            const modal = document.getElementById('resultModal');
            const resultId = modal.dataset.currentResultId;

            if (!resultId) {
                showAlert('danger', 'No result selected for editing');
                return;
            }

            const result = allResults.find(r => r.id === resultId);
            if (!result) return;

            // Replace the theory section with edit form
            const theoryCard = document.querySelector('.card-header:not(.bg-primary)').closest('.card').querySelector('.card-body');
            theoryCard.innerHTML = `
        <div class="theory-grading-form">
            <h5>Edit Theory Score</h5>
            <div class="mb-3">
                <label for="editTheoryScoreInput" class="form-label">Theory Score (0-100)</label>
                <input type="number" class="form-control" id="editTheoryScoreInput" min="0" max="100" 
                    value="${result.theoryScore || ''}" placeholder="Enter score">
            </div>
            <div class="mb-3">
                <label for="editTheoryGraderName" class="form-label">Grader Name</label>
                <input type="text" class="form-control" id="editTheoryGraderName" 
                    value="${result.theoryGradedBy || ''}" placeholder="Your name">
            </div>
            <div class="mb-3">
                <label for="editTheoryComments" class="form-label">Comments (Optional)</label>
                <textarea class="form-control" id="editTheoryComments" rows="2" 
                    placeholder="Any comments about this theory submission">${result.theoryComments || ''}</textarea>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success" id="updateTheoryScore">Update Theory Score</button>
                <button class="btn btn-secondary" id="cancelEditTheoryScore">Cancel</button>
            </div>
        </div>
    `;

            // Add event listeners
            setTimeout(() => {
                document.getElementById('updateTheoryScore').addEventListener('click', updateTheoryScore);
                document.getElementById('cancelEditTheoryScore').addEventListener('click', () => {
                    viewResultDetails(resultId); // Reload the details to show original view
                });
            }, 100);
        }

        // Function to update theory score
        function updateTheoryScore() {
            const modal = document.getElementById('resultModal');
            const resultId = modal.dataset.currentResultId;

            if (!resultId) {
                showAlert('danger', 'No result selected for theory score update');
                return;
            }

            // Get input values
            const theoryScoreInput = document.getElementById('editTheoryScoreInput');
            const graderNameInput = document.getElementById('editTheoryGraderName');
            const commentsInput = document.getElementById('editTheoryComments');

            const theoryScore = parseInt(theoryScoreInput.value);
            const graderName = graderNameInput.value.trim();
            const comments = commentsInput.value.trim();

            // Validate inputs
            if (isNaN(theoryScore) || theoryScore < 0 || theoryScore > 100) {
                showAlert('danger', 'Please enter a valid theory score between 0 and 100');
                return;
            }

            if (!graderName) {
                showAlert('danger', 'Please enter your name as the grader');
                return;
            }

            // Find the result to update
            const result = allResults.find(r => r.id === resultId);
            if (!result) return;

            // Calculate new total score based on exam type
            let totalScore = result.objectiveScore || 0;

            if (result.examType === 'ca') {
                totalScore = (result.objectiveScore * 0.5) + (theoryScore * 0.5);
            } else if (result.examType === 'midterm') {
                totalScore = (result.objectiveScore * 0.5) + (theoryScore * 0.5);
            } else if (result.examType === 'exam') {
                totalScore = (result.objectiveScore * 0.3) + (theoryScore * 0.7);
            }

            // Update the result in Firebase
            const resultRef = database.ref('examResults/' + resultId);
            const updates = {
                theoryScore: theoryScore,
                theoryGraded: true,
                theoryGradedBy: graderName,
                theoryGradedAt: new Date().toISOString(),
                totalScore: totalScore
            };

            // Add comments if provided
            if (comments) {
                updates.theoryComments = comments;
            }

            resultRef.update(updates)
                .then(() => {
                    showAlert('success', 'Theory score updated successfully!');
                    // Close the modal and reload results
                    bootstrap.Modal.getInstance(modal).hide();
                    loadResults();
                })
                .catch(error => {
                    console.error('Error updating theory score:', error);
                    showAlert('danger', 'Failed to update theory score.');
                });
        }


        // Apply filters to results
        function applyResultsFilters() {
            const classFilter = document.getElementById('filterClass').value;
            const subjectFilter = document.getElementById('filterSubject').value;
            const examTypeFilter = document.getElementById('filterExamType').value;
            const termFilter = document.getElementById('filterTerm').value;

            filteredResults = allResults.filter(result => {
                // Check class filter
                if (classFilter && result.class !== classFilter) return false;

                // Check subject filter
                if (subjectFilter && result.subject !== subjectFilter) return false;

                // Check exam type filter
                if (examTypeFilter && result.examType !== examTypeFilter) return false;

                // Check term filter
                if (termFilter && result.term !== termFilter) return false;

                return true;
            });

            // Reset to first page and update table
            currentPage = 1;
            updateResultsTable();
            updateCharts();
        }

        // Reset all filters
        function resetResultsFilters() {
            document.getElementById('filterClass').value = '';
            document.getElementById('filterSubject').value = '';
            document.getElementById('filterExamType').value = '';
            document.getElementById('filterTerm').value = '';

            filteredResults = [...allResults];
            currentPage = 1;
            updateResultsTable();
            updateCharts();
        }

        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(filteredResults.length / resultsPerPage);
            const pagination = document.getElementById('pagination');

            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) updateResultsTable(currentPage - 1);
            });
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    updateResultsTable(i);
                });
                pagination.appendChild(pageLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) updateResultsTable(currentPage + 1);
            });
            pagination.appendChild(nextLi);
        }

        // ==================== EXAM SETTINGS MANAGEMENT ====================

        // Load exam settings from Firebase
        function loadExamSettings() {
            const settingsRef = database.ref('examAvailability');

            settingsRef.on('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    examSettings = settings;

                    toggleExamPortal.checked = examSettings.isExamOpen || false;

                    examTypeCheckboxes.forEach(checkbox => {
                        checkbox.checked = examSettings.availableExamTypes?.includes(checkbox.value) || false;
                    });

                    if (examSettings.startDate) {
                        examStartDate.value = formatDateTimeForInput(examSettings.startDate);
                    }
                    if (examSettings.endDate) {
                        examEndDate.value = formatDateTimeForInput(examSettings.endDate);
                    }
                }
            });
        }

        // Save exam settings to Firebase
        function saveExamSettings() {
            const settingsRef = database.ref('examAvailability');

            const selectedExamTypes = [];
            examTypeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedExamTypes.push(checkbox.value);
                }
            });

            const settings = {
                isExamOpen: toggleExamPortal.checked,
                availableExamTypes: selectedExamTypes,
                startDate: examStartDate.value ? new Date(examStartDate.value).toISOString() : null,
                endDate: examEndDate.value ? new Date(examEndDate.value).toISOString() : null,
                lastUpdated: new Date().toISOString()
            };

            settingsRef.set(settings)
                .then(() => {
                    showAlert('success', 'Exam settings saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving exam settings:', error);
                    showAlert('danger', 'Failed to save exam settings.');
                });
        }

        // ==================== REPORT GENERATION ====================

        // Preview term report
        function previewTermReport() {
            const classVal = document.getElementById('reportClass').value;
            const termVal = document.getElementById('reportTerm').value;
            const sessionVal = document.getElementById('reportSession').value;

            if (!classVal || !termVal || !sessionVal) {
                showAlert('danger', 'Please select class, term and session');
                return;
            }

            let caWeight, midtermWeight, examWeight;

            if (termVal === 'summer') {
                caWeight = 0;
                midtermWeight = 0;
                examWeight = 100;
            } else {
                caWeight = parseInt(document.getElementById('caWeight').value) || 0;
                midtermWeight = parseInt(document.getElementById('midtermWeight').value) || 0;
                examWeight = parseInt(document.getElementById('examWeight').value) || 0;

                if (caWeight + midtermWeight + examWeight !== 100) {
                    showAlert('danger', 'Total weights must equal 100%');
                    return;
                }
            }

            // Calculate term totals
            calculateTermTotals(classVal, termVal, sessionVal, caWeight, midtermWeight, examWeight)
                .then(data => {
                    currentReportData = data;
                    renderReportPreview(data, classVal, termVal, sessionVal);
                    document.getElementById('reportPreview').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Error generating report:', error);
                    showAlert('danger', 'Failed to generate report. Please check console for details.');
                });
        }

        // Calculate term totals for all students
        function calculateTermTotals(classVal, termVal, sessionVal, caWeight, midtermWeight, examWeight) {
            return new Promise((resolve, reject) => {
                const resultsRef = database.ref('examResults');

                resultsRef.once('value')
                    .then(snapshot => {
                        const allResults = [];
                        snapshot.forEach(childSnapshot => {
                            const result = childSnapshot.val();
                            result.id = childSnapshot.key;
                            allResults.push(result);
                        });

                        // Filter results for the selected class, term and session
                        const filtered = allResults.filter(result =>
                            result.class === classVal &&
                            result.term === termVal &&
                            result.session === sessionVal
                        );

                        // Group by student and subject
                        const studentData = {};

                        filtered.forEach(result => {
                            if (!result.name || !result.subject || result.totalScore === undefined) return;

                            const studentKey = result.name.toLowerCase().trim();
                            const subjectKey = result.subject.toLowerCase().trim();

                            if (!studentData[studentKey]) {
                                studentData[studentKey] = {
                                    name: result.name,
                                    subjects: {},
                                    class: result.class,
                                    term: result.term,
                                    session: result.session
                                };
                            }

                            if (!studentData[studentKey].subjects[subjectKey]) {
                                studentData[studentKey].subjects[subjectKey] = {
                                    name: result.subject,
                                    caScores: [],
                                    midtermScores: [],
                                    examScores: []
                                };
                            }

                            // Categorize scores by exam type
                            if (result.examType === 'ca') {
                                studentData[studentKey].subjects[subjectKey].caScores.push(result.totalScore);
                            } else if (result.examType === 'midterm') {
                                studentData[studentKey].subjects[subjectKey].midtermScores.push(result.totalScore);
                            } else if (result.examType === 'exam') {
                                studentData[studentKey].subjects[subjectKey].examScores.push(result.totalScore);
                            }
                        });

                        // Calculate averages and totals for each student and subject
                        const reportData = Object.values(studentData).map(student => {
                            const subjects = {};

                            Object.entries(student.subjects).forEach(([subjectKey, subjectData]) => {
                                // Calculate CA average
                                const caAvg = subjectData.caScores.length > 0 ?
                                    subjectData.caScores.reduce((a, b) => a + b, 0) / subjectData.caScores.length : 0;

                                // Calculate Midterm average
                                const midtermAvg = subjectData.midtermScores.length > 0 ?
                                    subjectData.midtermScores.reduce((a, b) => a + b, 0) / subjectData.midtermScores.length : 0;

                                // Calculate Exam average
                                const examAvg = subjectData.examScores.length > 0 ?
                                    subjectData.examScores.reduce((a, b) => a + b, 0) / subjectData.examScores.length : 0;

                                // Calculate subject total based on weights
                                let subjectTotal = 0;

                                if (termVal === 'summer') {
                                    // For summer term, only use exam scores
                                    subjectTotal = examAvg;
                                } else {
                                    // For other terms, use weighted average
                                    subjectTotal = ((caAvg * caWeight) + (midtermAvg * midtermWeight) + (examAvg * examWeight)) / 100;
                                }

                                subjects[subjectKey] = {
                                    name: subjectData.name,
                                    caScores: subjectData.caScores,
                                    caAvg: caAvg,
                                    midtermScores: subjectData.midtermScores,
                                    midtermAvg: midtermAvg,
                                    examScores: subjectData.examScores,
                                    examAvg: examAvg,
                                    subjectTotal: subjectTotal
                                };
                            });

                            // Calculate overall average
                            const subjectTotals = Object.values(subjects).map(s => s.subjectTotal);
                            const overallAverage = subjectTotals.length > 0 ?
                                subjectTotals.reduce((a, b) => a + b, 0) / subjectTotals.length : 0;

                            return {
                                ...student,
                                subjects,
                                overallAverage
                            };
                        });

                        // Sort students by name
                        reportData.sort((a, b) => a.name.localeCompare(b.name));

                        resolve({
                            students: reportData,
                            weights: {
                                ca: caWeight,
                                midterm: midtermWeight,
                                exam: examWeight
                            },
                            class: classVal,
                            term: termVal,
                            session: sessionVal
                        });
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        }

        // Render report preview
        function renderReportPreview(data, classVal, termVal, sessionVal) {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = '';

            // Create header
            const header = document.createElement('div');
            header.className = 'text-center mb-4';

            if (termVal === 'summer') {
                header.innerHTML = `
                    <h3>The Climax Model Schools, Ota</h3>
                    <h4>Summer Term Report Sheet</h4>
                    <p>SUMMER TERM ${sessionVal} | ${classVal.toUpperCase()}</p>
                    <p>Exam: 100%</p>
                    <hr>
                `;
            } else {
                header.innerHTML = `
                    <h3>The Climax Model Schools, Ota</h3>
                    <h4>Term Report Sheet</h4>
                    <p>${termVal.toUpperCase()} TERM ${sessionVal} | ${classVal.toUpperCase()}</p>
                    <p>CA: ${data.weights.ca}% | Midterm: ${data.weights.midterm}% | Exam: ${data.weights.exam}%</p>
                    <hr>
                `;
            }

            previewContent.appendChild(header);

            // Create table for each student
            data.students.forEach(student => {
                const studentSection = document.createElement('div');
                studentSection.className = 'mb-4';

                const studentHeader = document.createElement('h5');
                studentHeader.textContent = `${student.name}`;
                studentSection.appendChild(studentHeader);

                // Create subjects table
                const table = document.createElement('table');
                table.className = 'table table-bordered';

                // Table header
                const thead = document.createElement('thead');

                if (termVal === 'summer') {
                    thead.innerHTML = `
                        <tr>
                            <th>Subject</th>
                            <th>Exam Score</th>
                            <th>Subject Total</th>
                            <th>Grade</th>
                        </tr>
                    `;
                } else {
                    thead.innerHTML = `
                        <tr>
                            <th>Subject</th>
                            <th>CA Avg</th>
                            <th>Midterm Avg</th>
                            <th>Exam Avg</th>
                            <th>Subject Total</th>
                            <th>Grade</th>
                        </tr>
                    `;
                }

                table.appendChild(thead);

                // Table body
                const tbody = document.createElement('tbody');

                Object.values(student.subjects).forEach(subject => {
                    const row = document.createElement('tr');

                    // Calculate grade
                    const grade = calculateGrade(subject.subjectTotal);

                    if (termVal === 'summer') {
                        row.innerHTML = `
                            <td>${capitalizeFirstLetter(subject.name)}</td>
                            <td>${subject.examScores.length > 0 ? Math.round(subject.examAvg) + '%' : '-'}</td>
                            <td>${Math.round(subject.subjectTotal)}%</td>
                            <td>${grade}</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td>${capitalizeFirstLetter(subject.name)}</td>
                            <td>${subject.caScores.length > 0 ? Math.round(subject.caAvg) + '%' : '-'}</td>
                            <td>${subject.midtermScores.length > 0 ? Math.round(subject.midtermAvg) + '%' : '-'}</td>
                            <td>${subject.examScores.length > 0 ? Math.round(subject.examAvg) + '%' : '-'}</td>
                            <td>${Math.round(subject.subjectTotal)}%</td>
                            <td>${grade}</td>
                        `;
                    }

                    tbody.appendChild(row);
                });

                // Add overall average row
                const footerRow = document.createElement('tr');
                footerRow.className = 'table-active';

                if (termVal === 'summer') {
                    footerRow.innerHTML = `
                        <td colspan="2" class="text-end"><strong>Overall Average:</strong></td>
                        <td><strong>${Math.round(student.overallAverage)}%</strong></td>
                        <td><strong>${calculateGrade(student.overallAverage)}</strong></td>
                    `;
                } else {
                    footerRow.innerHTML = `
                        <td colspan="4" class="text-end"><strong>Overall Average:</strong></td>
                        <td><strong>${Math.round(student.overallAverage)}%</strong></td>
                        <td><strong>${calculateGrade(student.overallAverage)}</strong></td>
                    `;
                }

                tbody.appendChild(footerRow);

                table.appendChild(tbody);
                studentSection.appendChild(table);
                previewContent.appendChild(studentSection);
            });
        }

        // Generate PDF report
        function generateTermReportPdf() {
            if (!currentReportData) {
                showAlert('danger', 'Please preview the report first');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const termVal = currentReportData.term;

            // Add header
            doc.setFontSize(16);
            doc.setTextColor(26, 95, 180); // School color
            doc.text('The Climax Model Schools, Ota', 105, 15, { align: 'center' });

            doc.setFontSize(14);

            if (termVal === 'summer') {
                doc.text('Summer Term Report Sheet', 105, 22, { align: 'center' });
            } else {
                doc.text('Term Report Sheet', 105, 22, { align: 'center' });
            }

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0); // Black color

            if (termVal === 'summer') {
                doc.text(`SUMMER TERM ${currentReportData.session} | ${currentReportData.class.toUpperCase()}`, 105, 30, { align: 'center' });
                doc.text(`Exam: 100%`, 105, 37, { align: 'center' });
            } else {
                doc.text(`${currentReportData.term.toUpperCase()} TERM ${currentReportData.session} | ${currentReportData.class.toUpperCase()}`, 105, 30, { align: 'center' });
                doc.text(`CA: ${currentReportData.weights.ca}% | Midterm: ${currentReportData.weights.midterm}% | Exam: ${currentReportData.weights.exam}%`, 105, 37, { align: 'center' });
            }

            // Add student tables
            let yPosition = 45;

            currentReportData.students.forEach((student, index) => {
                // Add student name
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${student.name}`, 14, yPosition);
                doc.setFont(undefined, 'normal');

                yPosition += 7;

                // Prepare data for the table
                const tableData = [];

                Object.values(student.subjects).forEach(subject => {
                    // Calculate grade
                    const grade = calculateGrade(subject.subjectTotal);

                    if (termVal === 'summer') {
                        tableData.push([
                            capitalizeFirstLetter(subject.name),
                            subject.examScores.length > 0 ? `${Math.round(subject.examAvg)}%` : '-',
                            `${Math.round(subject.subjectTotal)}%`,
                            grade
                        ]);
                    } else {
                        tableData.push([
                            capitalizeFirstLetter(subject.name),
                            subject.caScores.length > 0 ? `${Math.round(subject.caAvg)}%` : '-',
                            subject.midtermScores.length > 0 ? `${Math.round(subject.midtermAvg)}%` : '-',
                            subject.examScores.length > 0 ? `${Math.round(subject.examAvg)}%` : '-',
                            `${Math.round(subject.subjectTotal)}%`,
                            grade
                        ]);
                    }
                });

                // Add overall average row
                if (termVal === 'summer') {
                    tableData.push([
                        { content: 'Overall Average:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } },
                        { content: `${Math.round(student.overallAverage)}%`, styles: { fontStyle: 'bold' } },
                        { content: calculateGrade(student.overallAverage), styles: { fontStyle: 'bold' } }
                    ]);
                } else {
                    tableData.push([
                        { content: 'Overall Average:', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } },
                        { content: `${Math.round(student.overallAverage)}%`, styles: { fontStyle: 'bold' } },
                        { content: calculateGrade(student.overallAverage), styles: { fontStyle: 'bold' } }
                    ]);
                }

                // Add table to PDF
                if (termVal === 'summer') {
                    doc.autoTable({
                        startY: yPosition,
                        head: [['Subject', 'Exam Score', 'Total', 'Grade']],
                        body: tableData,
                        margin: { left: 10, right: 10 },
                        styles: { fontSize: 9 },
                        headStyles: { fillColor: [26, 95, 180], textColor: 255, fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [240, 240, 240] }
                    });
                } else {
                    doc.autoTable({
                        startY: yPosition,
                        head: [['Subject', 'CA Avg', 'Midterm Avg', 'Exam Avg', 'Total', 'Grade']],
                        body: tableData,
                        margin: { left: 10, right: 10 },
                        styles: { fontSize: 9 },
                        headStyles: { fillColor: [26, 95, 180], textColor: 255, fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [240, 240, 240] }
                    });
                }

                yPosition = doc.lastAutoTable.finalY + 10;

                // Add page break if not the last student and we're running out of space
                if (index < currentReportData.students.length - 1 && yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
            });

            // Save the PDF
            const fileName = `Term_Report_${currentReportData.class}_${currentReportData.term}_${currentReportData.session}.pdf`;
            doc.save(fileName);
        }

        // ==================== CHARTS & VISUALIZATION ====================

        // Update charts
        function updateCharts() {
            updatePerformanceChart();
            updateScoreDistributionChart();
            updateTrendsChart();
        }

        // Performance chart (by class/subject)
        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            // Destroy previous chart if exists
            if (performanceChart) {
                performanceChart.destroy();
            }

            // Group data by class and subject
            const performanceData = {};
            filteredResults.forEach(result => {
                if (!result.class || !result.subject) return;

                if (!performanceData[result.class]) {
                    performanceData[result.class] = {};
                }

                if (!performanceData[result.class][result.subject]) {
                    performanceData[result.class][result.subject] = {
                        total: 0,
                        count: 0
                    };
                }

                if (result.totalScore) {
                    performanceData[result.class][result.subject].total += result.totalScore;
                    performanceData[result.class][result.subject].count++;
                }
            });

            // Prepare chart data
            const classes = Object.keys(performanceData);
            const subjects = Array.from(new Set(filteredResults.map(r => r.subject).filter(Boolean)));

            const datasets = subjects.map(subject => {
                return {
                    label: capitalizeFirstLetter(subject),
                    data: classes.map(cls => {
                        const subjData = performanceData[cls][subject];
                        return subjData && subjData.count > 0
                            ? Math.round(subjData.total / subjData.count)
                            : 0;
                    }),
                    backgroundColor: getRandomColor()
                };
            });

            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: classes.map(cls => cls.toUpperCase()),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Average Score (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Average Performance by Class and Subject'
                        }
                    }
                }
            });
        }

        // Score distribution chart
        function updateScoreDistributionChart() {
            const ctx = document.getElementById('scoreChart').getContext('2d');

            if (scoreChart) {
                scoreChart.destroy();
            }

            // Categorize scores
            const scoreRanges = {
                '90-100': 0,
                '80-89': 0,
                '70-79': 0,
                '60-69': 0,
                '50-59': 0,
                'Below 50': 0
            };

            filteredResults.forEach(result => {
                if (result.totalScore) {
                    if (result.totalScore >= 90) scoreRanges['90-100']++;
                    else if (result.totalScore >= 80) scoreRanges['80-89']++;
                    else if (result.totalScore >= 70) scoreRanges['70-79']++;
                    else if (result.totalScore >= 60) scoreRanges['60-69']++;
                    else if (result.totalScore >= 50) scoreRanges['50-59']++;
                    else scoreRanges['Below 50']++;
                }
            });

            scoreChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(scoreRanges),
                    datasets: [{
                        data: Object.values(scoreRanges),
                        backgroundColor: [
                            '#28a745',
                            '#5cb85c',
                            '#ffc107',
                            '#fd7e14',
                            '#dc3545',
                            '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Score Distribution'
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Trends over time chart
        function updateTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');

            if (trendsChart) {
                trendsChart.destroy();
            }

            // Group by date (last 30 days)
            const now = new Date();
            const last30Days = Array.from({ length: 30 }, (_, i) => {
                const date = new Date(now);
                date.setDate(date.getDate() - (29 - i));
                return date.toISOString().split('T')[0];
            });

            const dailyAverages = {};
            last30Days.forEach(date => {
                dailyAverages[date] = {
                    total: 0,
                    count: 0
                };
            });

            filteredResults.forEach(result => {
                const resultDate = new Date(result.timestamp).toISOString().split('T')[0];
                if (dailyAverages[resultDate] && result.totalScore) {
                    dailyAverages[resultDate].total += result.totalScore;
                    dailyAverages[resultDate].count++;
                }
            });

            const labels = last30Days.map(date => formatShortDate(date));
            const data = last30Days.map(date => {
                return dailyAverages[date].count > 0
                    ? Math.round(dailyAverages[date].total / dailyAverages[date].count)
                    : null;
            });

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Average Score (%)',
                        data: data,
                        backgroundColor: 'rgba(26, 95, 180, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Average Score (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Trends (Last 30 Days)'
                        }
                    }
                }
            });
        }

        // ==================== UTILITY FUNCTIONS ====================

        // Export to Excel
        function exportToExcel() {
            if (filteredResults.length === 0) {
                alert('No results to export');
                return;
            }

            // Prepare data for export
            const exportData = filteredResults.map(result => {
                return {
                    'Student Name': result.name || '',
                    'Class': result.class ? result.class.toUpperCase() : '',
                    'Subject': result.subject ? capitalizeFirstLetter(result.subject) : '',
                    'Exam Type': getExamTypeText(result.examType),
                    'Term': result.term || '',
                    'Session': result.session || '',
                    'Objective Score (%)': result.objectiveScore || '',
                    'Theory Score (%)': result.theoryScore || '',
                    'Total Score (%)': result.totalScore || '',
                    'Theory Submitted': result.theorySubmitted ? 'Yes' : 'No',
                    'Theory Graded': result.theoryGraded ? 'Yes' : 'No',
                    'Date Submitted': formatDate(result.timestamp)
                };
            });

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Exam Results');

            // Export to file
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Exam_Results_${dateStr}.xlsx`);
        }

        // Print result details
        function printResultDetails() {
            const printContent = document.getElementById('resultDetails').innerHTML;
            const originalContent = document.body.innerHTML;

            document.body.innerHTML = `
        <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>The Climax Model Schools, Ota</h2>
                <h3>Exam Result Details</h3>
            </div>
            ${printContent}
            <div style="margin-top: 30px; text-align: right; font-style: italic;">
                Printed on ${new Date().toLocaleDateString()}
            </div>
        </div>
    `;

            window.print();
            document.body.innerHTML = originalContent;
        }

        // Show alert message
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

            const container = document.querySelector('.container-fluid');
            container.prepend(alertDiv);

            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 3000);
        }

        // Helper function to format datetime for input
        function formatDateTimeForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';

            const pad = num => num.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        // Helper function to get exam type display
        function getExamTypeDisplay(type) {
            switch (type) {
                case 'ca': return '<span class="badge bg-primary">CA</span>';
                case 'midterm': return '<span class="badge bg-warning text-dark">Midterm</span>';
                case 'exam': return '<span class="badge bg-danger">Exam</span>';
                default: return 'N/A';
            }
        }

        // Helper function to get exam type text
        function getExamTypeText(type) {
            switch (type) {
                case 'ca': return 'Continuous Assessment';
                case 'midterm': return 'Midterm Exam';
                case 'exam': return 'End of Term Exam';
                default: return type || 'N/A';
            }
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';

            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Helper function to format short date
        function formatShortDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }

        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Helper function to get score class
        function getScoreClass(score) {
            if (score === undefined || score === null) return '';
            if (score >= 70) return 'high-score';
            if (score >= 50) return 'medium-score';
            return 'low-score';
        }

        // Helper function to get random color
        function getRandomColor() {
            return `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
        }

        // Helper function to calculate grade
        function calculateGrade(score) {
            if (score >= 75) return 'A1';
            if (score >= 70) return 'B2';
            if (score >= 65) return 'B3';
            if (score >= 60) return 'C4';
            if (score >= 55) return 'C5';
            if (score >= 50) return 'C6';
            if (score >= 45) return 'D7';
            if (score >= 40) return 'E8';
            return 'F9';
        }
    </script>
</body>

</html>